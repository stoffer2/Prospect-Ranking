<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rankle – Consensus MLB Prospect Rankings</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&family=Oswald:wght@500;600&display=swap" rel="stylesheet">
<style>
:root {
    --bg-deep:    #0a0e1a;
    --bg-card:    #141b29;
    --bg-row:     #181f32;
    --bg-row-alt: #131a28;
    --border:     #1e2a40;
    --text-hi:    #f1f5f9;
    --text-mid:   #94a3b8;
    --text-lo:    #4c5a72;
    --accent:     #3b82f6;
    --accent-hi:  #60a5fa;
    --gold:       #f59e0b;
    --green:      #34d399;
    --red:        #f87171;
    --purple:     #a78bfa;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg-deep);
    color: var(--text-hi);
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
}

/* ── HEADER ── */
header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,14,26,0.9);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    border-top: 3px solid var(--accent);
    padding: 0 2rem;
    height: 64px;
    display: flex; align-items: center; justify-content: space-between;
}
.logo-title {
    font-family: 'Bebas Neue', cursive;
    font-size: 2.2rem;
    letter-spacing: 2px;
    background: linear-gradient(135deg, #fef3c7 0%, #f59e0b 40%, #d97706 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    filter: drop-shadow(0 2px 4px rgba(245,158,11,0.35));
}
.header-stats {
    display: flex; gap: 1.5rem; font-size: 0.75rem; color: var(--text-lo);
    letter-spacing: 0.5px;
}
.header-stats strong { color: var(--accent-hi); }
.header-right { display:flex; align-items:center; gap:1rem; }
.btn-pro {
    background: linear-gradient(135deg,#2563eb,#1d4ed8);
    color:#fff; border:none; padding:0.45rem 1rem;
    border-radius:6px; font-size:0.8rem; font-weight:600;
    cursor:pointer; letter-spacing:0.3px;
    transition: transform .15s, box-shadow .15s;
}
.btn-pro:hover { transform:translateY(-1px); box-shadow:0 4px 14px rgba(37,99,235,.5); }

/* ── HERO ── */
.hero {
    position: relative;
    background: linear-gradient(160deg, #0f1d3a 0%, #0a0e1a 70%);
    border-bottom: 1px solid var(--border);
    padding: 2.5rem 2rem 3rem;
    overflow: hidden;
}
.hero::before {
    content: '';
    position: absolute; inset: 0;
    background-image: radial-gradient(circle at 20% 50%, rgba(59,130,246,0.06) 0%, transparent 50%),
                      radial-gradient(circle at 80% 20%, rgba(245,158,11,0.04) 0%, transparent 40%);
    pointer-events: none;
}
.hero::after {
    content: '';
    position: absolute; inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%231e2a40' fill-opacity='0.4'%3E%3Ccircle cx='20' cy='20' r='0.5'/%3E%3C/g%3E%3C/svg%3E");
    opacity: 0.6;
    pointer-events: none;
}
.hero-inner {
    position: relative; z-index: 1;
    max-width: 1200px; margin: 0 auto;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 3rem;
    align-items: center;
    text-align: left;
}
.hero-content { max-width: 520px; }
.hero-label {
    font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
    letter-spacing: 2.5px; color: var(--accent-hi);
    margin-bottom: 0.5rem;
}
.hero h1 {
    font-family: 'Oswald', sans-serif;
    font-size: 2.6rem; font-weight: 600;
    letter-spacing: 2px; line-height: 1.1;
    margin-bottom: 0.75rem;
}
.hero h1 .highlight { color: var(--accent-hi); }
.hero-desc { color: var(--text-mid); font-size: 0.95rem; line-height: 1.6; margin-bottom: 1.25rem; }
.hero-pills {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}
.hero-pill {
    font-size: 0.72rem; font-weight: 600;
    color: var(--text-mid);
    letter-spacing: 0.6px;
    padding: 0.35rem 0.7rem;
    background: rgba(30,42,64,0.6);
    border: 1px solid var(--border);
    border-radius: 6px;
}
.hero-preview {
    background: rgba(20,27,41,0.6);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem 1.5rem;
    min-width: 240px;
    position: relative;
}
.hero-preview-title {
    font-size: 0.65rem; font-weight: 700; text-transform: uppercase;
    letter-spacing: 1.5px; color: var(--text-lo);
    margin-bottom: 0.75rem;
}
.hero-preview-list { display: flex; flex-direction: column; gap: 0.4rem; }
.hero-preview-item {
    display: flex; align-items: center; gap: 0.6rem;
    font-size: 0.82rem; font-weight: 500;
}
.hero-preview-rank {
    width: 24px; height: 24px;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.7rem; font-weight: 700;
    border-radius: 6px;
    flex-shrink: 0;
}
.hero-preview-rank.gold { background: linear-gradient(135deg,#f59e0b,#d97706); color:#1a1a1a; }
.hero-preview-rank.silver { background: linear-gradient(135deg,#cbd5e1,#94a3b8); color:#1a1a1a; }
.hero-preview-rank.bronze { background: linear-gradient(135deg,#f97316,#ea580c); color:#fff; }
.hero-preview-rank.steel { background: var(--bg-card); color: var(--text-mid); border: 1px solid var(--border); }

.hero-legend { display: flex; flex-direction: column; gap: 0.75rem; }
.hero-legend-item {
    font-size: 0.7rem;
    color: var(--text-mid);
    line-height: 1.4;
}
.hero-legend-item strong { color: var(--text-hi); font-weight: 600; }
.hero-legend-item .cons-dots { display: inline-flex; gap: 0.2rem; margin-left: 0.25rem; vertical-align: middle; }
.hero-legend-item .cons-dot { width: 6px; height: 6px; }
.hero-legend-note {
    display: block;
    font-size: 0.62rem;
    color: var(--text-lo);
    margin-top: 0.2rem;
}
.hero-legend-vols { display: flex; gap: 0.35rem; flex-wrap: wrap; margin-top: 0.2rem; }

@media (max-width: 900px) {
    .hero-inner { grid-template-columns: 1fr; text-align: center; }
    .hero-content { max-width: 100%; }
    .hero-pills { justify-content: center; }
    .hero-preview { justify-self: center; }
}

/* ── FILTER BAR ── */
.filter-bar {
    max-width:1100px; margin: 1.5rem auto 1rem;
    padding: 0 1.5rem;
    display:flex; gap:.75rem; align-items:flex-end; flex-wrap:wrap;
}
.filter-group { display:flex; flex-direction:column; gap:.3rem; flex:1; min-width:140px; }
.filter-group label { font-size:.7rem; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-lo); }
.filter-group input,
.filter-group select {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius:6px;
    padding: .5rem .7rem;
    color: var(--text-hi);
    font-size:.85rem;
    font-family: inherit;
    outline:none;
    transition: border-color .2s;
}
.filter-group input:focus,
.filter-group select:focus { border-color: var(--accent); }
.filter-group input::placeholder { color:var(--text-lo); }

/* ── TABLE ── */
.table-wrap {
    max-width:1100px; margin:0 auto 2rem;
    padding:0 1.5rem;
}
table { width:100%; border-collapse:collapse; }

thead th {
    position: sticky;
    top: 64px;
    z-index: 10;
    background: var(--bg-deep);
    text-align:left;
    font-size:.68rem; text-transform:uppercase; letter-spacing:1.3px;
    color:var(--text-lo); font-weight:600;
    padding:.7rem .65rem;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
}
thead th:first-child { padding-left:1rem; }

tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background .15s;
}
tbody tr:nth-child(odd)  { background: var(--bg-row); }
tbody tr:nth-child(even) { background: var(--bg-row-alt); }
tbody tr:hover           { background: rgba(59,130,246,.07); }

td { padding:.75rem .65rem; vertical-align:middle; }
td:first-child { padding-left:1rem; }

/* rank pill */
.rank-pill {
    display:inline-flex; align-items:center; justify-content:center;
    width:38px; height:38px; border-radius:8px;
    font-weight:700; font-size:.88rem;
}
.rank-gold   { background:linear-gradient(135deg,#f59e0b,#d97706); color:#1a1a1a; box-shadow:0 2px 8px rgba(245,158,11,.35); }
.rank-silver { background:linear-gradient(135deg,#cbd5e1,#94a3b8); color:#1a1a1a; box-shadow:0 2px 6px rgba(148,163,175,.3); }
.rank-bronze { background:linear-gradient(135deg,#f97316,#ea580c); color:#fff;    box-shadow:0 2px 6px rgba(249,115,22,.35); }
.rank-steel  { background:var(--bg-card); color:var(--text-mid); border:1px solid var(--border); }

/* name col */
.p-name { font-weight:600; font-size:.9rem; color:var(--text-hi); }

/* pos badge */
.pos-badge {
    display:inline-block; padding:.2rem .55rem;
    border-radius:20px; font-size:.72rem; font-weight:600;
    background:rgba(59,130,246,.15); color:#7dd3fc;
}

.team-col { font-weight:600; font-size:.85rem; color:var(--text-mid); }
.num-col  { font-size:.85rem; color:var(--text-mid); }

/* borda score */
.borda-col { font-weight:700; font-size:.9rem; color:var(--accent-hi); }

/* SD / volatility */
.vol-wrap { display:flex; align-items:center; gap:.45rem; }
.vol-num  { font-size:.78rem; color:var(--text-mid); font-weight:500; }
.vol-badge {
    font-size:.65rem; font-weight:700; text-transform:uppercase;
    letter-spacing:.8px; padding:.15rem .42rem; border-radius:4px;
}
.vol-low     { background:rgba(52,211,153,.15); color:#34d399; }
.vol-mod     { background:rgba(251,191,36,.15); color:#fbbf24; }
.vol-high    { background:rgba(248,113,113,.15); color:#f87171; }
.vol-extreme { background:rgba(139,92,246,.15); color:#a78bfa; }
.vol-na      { background:rgba(100,116,139,.15); color:var(--text-lo); }

/* consensus dots */
.cons-dots { display:flex; gap:.3rem; }
.cons-dot  { width:8px; height:8px; border-radius:50%; background:var(--border); }
.cons-dot.on { background:var(--gold); box-shadow:0 0 4px rgba(245,158,11,.4); }



/* single-source warning */
.warn-badge {
    display:inline-flex; align-items:center; gap:.25rem;
    font-size:.68rem; color:#fbbf24; font-weight:600;
    background:rgba(251,191,36,.1); padding:.12rem .4rem; border-radius:4px;
    margin-left:.4rem;
}

/* ── LOCKED SECTION ── */
.lock-row td { padding:0; border:none !important; }
.lock-box {
    background: linear-gradient(135deg, rgba(20,27,41,0.95), rgba(10,14,26,0.98));
    border: 1px solid var(--border);
    border-radius:14px;
    padding:2.5rem 2rem;
    text-align:center;
    max-width:420px; margin:1.8rem auto;
}
.lock-icon { font-size:2.8rem; margin-bottom:.6rem; }
.lock-title { font-family:'Bebas Neue',cursive; font-size:1.55rem; letter-spacing:2px; margin-bottom:.35rem; }
.lock-desc { color:var(--text-mid); font-size:.82rem; line-height:1.5; margin-bottom:1.2rem; max-width:320px; margin-left:auto; margin-right:auto; }
.btn-unlock {
    background: linear-gradient(135deg,#2563eb,#1d4ed8);
    color:#fff; border:none; padding:.6rem 1.6rem;
    border-radius:8px; font-size:.92rem; font-weight:700;
    cursor:pointer; transition: transform .15s, box-shadow .15s;
    box-shadow: 0 3px 16px rgba(37,99,235,.4);
}
.btn-unlock:hover { transform:translateY(-2px); box-shadow:0 6px 24px rgba(37,99,235,.5); }

.locked-ghost { opacity:.28; filter:blur(3.5px); pointer-events:none; user-select:none; }

/* ── METHODOLOGY ── */
.method-section {
    max-width:1100px; margin: 0 auto 2.5rem;
    padding: 0 1.5rem;
}
.method-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius:12px;
    padding:2rem;
}
.method-card h3 { font-family:'Bebas Neue',cursive; font-size:1.3rem; letter-spacing:2px; margin-bottom:1rem; color:#fff; }
.method-grid { display:grid; grid-template-columns:1fr 1fr; gap:2rem; }
.method-item h4 { font-size:.82rem; color:var(--accent-hi); font-weight:600; margin-bottom:.35rem; text-transform:uppercase; letter-spacing:0.8px; }
.method-item p  { font-size:.8rem; color:var(--text-mid); line-height:1.65; }

/* ── FOOTER ── */
footer {
    border-top: 1px solid var(--border);
    padding: 2rem 1.5rem;
    text-align:center;
    color:var(--text-lo); font-size:.73rem;
    margin-top:1rem;
}

/* ── ROSTER UPLOAD ── */
.btn-upload-roster {
    background: linear-gradient(135deg, #f59e0b, #fbbf24);
    color: #1a1a1a;
    border: none;
    border-radius: 6px;
    padding: 0.45rem 1rem;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    letter-spacing: 0.3px;
    transition: transform .15s, box-shadow .15s;
}
.btn-upload-roster:hover { transform: translateY(-1px); box-shadow: 0 4px 14px rgba(251,191,36,.45); }
.btn-upload-roster.loaded { background: var(--green); color: #0a0e1a; }
.btn-upload-roster.loaded:hover { box-shadow: 0 4px 14px rgba(52,211,153,.4); }
.fantasy-section {
    display: none;
    padding: 1rem 2rem;
    background: var(--bg-card);
    border-bottom: 1px solid var(--border);
}
.fantasy-section.open { display: block; }
.fantasy-desc { color: var(--text-mid); font-size: 0.82rem; margin-bottom: 0.75rem; line-height: 1.5; }
.fantasy-drop-zone {
    position: relative;
    border: 2px dashed var(--border);
    border-radius: 8px;
    transition: border-color .2s, background .2s;
}
.fantasy-drop-zone.drag-over { border-color: var(--gold); background: rgba(245,158,11,.08); }
.fantasy-drop-zone.success { border-color: var(--green); background: rgba(52,211,153,.06); }
.fantasy-drop-content {
    padding: 2rem 1rem;
    text-align: center;
    position: relative;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
}
.fantasy-drop-placeholder {
    color: var(--text-mid);
    font-size: 0.9rem;
}
.fantasy-drop-processing,
.fantasy-drop-success { display: none; }
.fantasy-drop-zone.processing .fantasy-drop-placeholder { display: none; }
.fantasy-drop-zone.processing .fantasy-drop-processing { display: flex; flex-direction: column; align-items: center; gap: 0.75rem; }
.fantasy-drop-zone.processing .fantasy-drop-success { display: none; }
.fantasy-drop-zone.success .fantasy-drop-placeholder,
.fantasy-drop-zone.success .fantasy-drop-processing { display: none; }
.fantasy-drop-zone.success .fantasy-drop-success { display: flex; flex-direction: column; align-items: center; gap: 0.5rem; }
.fantasy-drop-processing span { color: var(--text-mid); font-size: 0.9rem; }
.fantasy-checkmark {
    width: 48px; height: 48px;
    border-radius: 50%;
    background: rgba(52,211,153,.2);
    color: var(--green);
    font-size: 1.6rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: checkmark-pop 0.35s ease-out;
}
@keyframes checkmark-pop {
    0% { transform: scale(0); opacity: 0; }
    60% { transform: scale(1.15); }
    100% { transform: scale(1); opacity: 1; }
}
.fantasy-drop-success span:last-child { color: var(--green); font-weight: 600; font-size: 0.95rem; }
.fantasy-progress-wrap {
    display: none;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--border);
    border-radius: 0 0 6px 6px;
    overflow: hidden;
}
.fantasy-drop-zone.processing .fantasy-progress-wrap { display: block; }
.fantasy-drop-zone.success .fantasy-progress-wrap { display: none; }
.fantasy-progress-bar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--accent), var(--accent-hi));
    transition: width 0.12s ease-out;
}
.fantasy-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
.btn-apply { background: var(--accent); color: #fff; border: none; padding: 0.4rem 1rem; border-radius: 6px; font-size: 0.82rem; cursor: pointer; }
.btn-apply:hover { background: var(--accent-hi); }
.btn-clear { background: transparent; color: var(--text-mid); border: 1px solid var(--border); padding: 0.4rem 1rem; border-radius: 6px; font-size: 0.82rem; cursor: pointer; }
.btn-clear:hover { border-color: var(--text-lo); color: var(--text-hi); }
.draft-col { font-size: 0.8rem; color: var(--text-mid); }

/* ── TOAST ── */
.fantasy-toast {
    position: fixed;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--bg-card);
    border: 1px solid var(--border);
    box-shadow: 0 8px 24px rgba(0,0,0,.4);
    border-radius: 10px;
    padding: 1rem 1.5rem;
    z-index: 9999;
    opacity: 0;
    transition: transform .3s, opacity .3s;
    max-width: 90%;
}
.fantasy-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
}
.fantasy-toast strong { color: var(--green); }

/* ── RESPONSIVE ── */
/* Tablet and below */
@media (max-width: 768px) {
    header { padding: 0 1rem; height: 56px; }
    thead th { top: 56px; }
    .header-stats { display: none; }
    .logo-title { font-size: 1.8rem; }
    .btn-pro { padding: 0.4rem 0.85rem; font-size: 0.75rem; }
    .hero { padding: 2rem 1rem 2rem; }
    .hero h1 { font-size: 2rem; }
    .hero-desc { font-size: 0.9rem; }
    .hero-pills { justify-content: center; gap: 0.6rem; }
    .hero-pill { font-size: 0.68rem; }
    .filter-bar { margin: 1rem auto 0.75rem; padding: 0 1rem; gap: 0.6rem; }
    .filter-group { min-width: 0; flex: 1 1 45%; }
    .filter-group[style*="flex:2"] { flex: 1 1 100%; }
    .table-wrap { padding: 0 1rem; margin-bottom: 1.5rem; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .table-wrap::after { content: ''; display: block; height: 1px; }
    table { min-width: 680px; }
    thead th, td { padding: 0.6rem 0.5rem; font-size: 0.8rem; }
    thead th:first-child, td:first-child { padding-left: 0.75rem; }
    .rank-pill { width: 34px; height: 34px; font-size: 0.8rem; }
    .p-name { font-size: 0.85rem; }
    .method-section { margin: 0 auto 1.5rem; padding: 0 1rem; }
    .method-card { padding: 1.5rem; }
    .method-grid { grid-template-columns: 1fr; gap: 1.25rem; }
    .method-item p { font-size: 0.78rem; }
    footer { padding: 1.5rem 1rem; font-size: 0.7rem; }
}

/* Mobile (small phones) */
@media (max-width: 480px) {
    header { padding: 0 0.75rem; height: 52px; }
    thead th { top: 52px; }
    .logo-title { font-size: 1.55rem; letter-spacing: 1px; }
    .hero { padding: 1.5rem 0.75rem 1.5rem; }
    .hero h1 { font-size: 1.65rem; }
    .hero-desc { font-size: 0.85rem; }
    .hero-pills { flex-direction: column; align-items: center; gap: 0.5rem; }
    .hero-pill { font-size: 0.65rem; }
    .filter-bar { padding: 0 0.75rem; flex-direction: column; }
    .filter-group { flex: 1 1 auto !important; width: 100%; }
    .filter-group input, .filter-group select { padding: 0.55rem 0.75rem; min-height: 44px; font-size: 1rem; }
    .table-wrap { padding: 0 0.5rem; margin-left: -0.25rem; margin-right: -0.25rem; }
    table { min-width: 640px; font-size: 0.78rem; }
    thead th, td { padding: 0.5rem 0.4rem; font-size: 0.75rem; }
    thead th:first-child, td:first-child { padding-left: 0.5rem; }
    .rank-pill { width: 30px; height: 30px; font-size: 0.75rem; }
    .pos-badge { padding: 0.15rem 0.4rem; font-size: 0.65rem; }
    .vol-badge { font-size: 0.6rem; padding: 0.12rem 0.35rem; }
    .cons-dot { width: 6px; height: 6px; }
    .method-card { padding: 1.25rem; }
    .method-card h3 { font-size: 1.15rem; }
    .method-item h4 { font-size: 0.75rem; }
    .method-item p { font-size: 0.75rem; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header>
    <span class="logo-title">Rankle</span>
    <div class="header-stats">
        <span><strong>9</strong> sources</span>
        <span><strong>100+</strong> prospects</span>
    </div>
    <div class="header-right">
        <button type="button" class="btn-upload-roster" id="btnUploadRoster" onclick="document.getElementById('fantasySection').classList.toggle('open')">Upload your league's roster</button>
        <button class="btn-pro">⭐ Upgrade to Pro</button>
    </div>
</header>

<div class="fantasy-section" id="fantasySection">
    <p class="fantasy-desc">Drop your roster CSV or paste (Ctrl+V).</p>
    <div class="fantasy-drop-zone" id="fantasyDropZone" tabindex="0">
        <div class="fantasy-drop-content">
            <div class="fantasy-drop-placeholder">Drop CSV file or paste (Ctrl+V)</div>
            <div class="fantasy-drop-processing">
                <span>Processing…</span>
            </div>
            <div class="fantasy-drop-success">
                <div class="fantasy-checkmark">✓</div>
                <span>Roster imported!</span>
            </div>
        </div>
        <div class="fantasy-progress-wrap">
            <div class="fantasy-progress-bar" id="fantasyProgressBar"></div>
        </div>
    </div>
</div>

<!-- HERO -->
<div class="hero">
    <div class="hero-inner">
        <div class="hero-content">
            <div class="hero-label">MLB Prospect Rankings</div>
            <h1>Data-Driven <span class="highlight">Prospect Ranking</span></h1>
            <p class="hero-desc">The Rankle Score aggregates expert rankings through a robust algorithm—one consensus view that vastly simplifies and improves prospect ranking.</p>
            <div class="hero-pills">
                <span class="hero-pill">Z-score aggregation</span>
                <span class="hero-pill">Volatility scoring</span>
                <span class="hero-pill">Multi-source consensus</span>
            </div>
        </div>
        <div class="hero-preview">
            <div class="hero-preview-title">How to read the table</div>
            <div class="hero-legend">
                <div class="hero-legend-item">
                    <strong>Score</strong> — 0–100, higher = better consensus rank
                </div>
                <div class="hero-legend-item">
                    <strong>Consensus</strong> <div class="cons-dots"><div class="cons-dot on"></div><div class="cons-dot on"></div><div class="cons-dot on"></div><div class="cons-dot"></div><div class="cons-dot"></div><div class="cons-dot"></div></div>
                    <span class="hero-legend-note">Lit dots = sources that agreed on position</span>
                </div>
                <div class="hero-legend-item">
                    <strong>Volatility</strong>
                    <div class="hero-legend-vols">
                        <span class="vol-badge vol-low">Low</span>
                        <span class="vol-badge vol-mod">Mod</span>
                        <span class="vol-badge vol-high">High</span>
                        <span class="vol-badge vol-extreme">Ext</span>
                    </div>
                    <span class="hero-legend-note">Lower = sources agree; higher = more disagreement</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FILTERS -->
<div class="filter-bar">
    <div class="filter-group" style="flex:2;">
        <label>Search</label>
        <input type="text" id="searchInput" placeholder="Player name…">
    </div>
    <div class="filter-group">
        <label>Position</label>
        <select id="posFilter"></select>
    </div>
    <div class="filter-group">
        <label>Team</label>
        <select id="teamFilter"></select>
    </div>
    <div class="filter-group">
        <label>Volatility</label>
        <select id="volFilter">
            <option value="ALL">All</option>
            <option value="Low">Low</option>
            <option value="Moderate">Moderate</option>
            <option value="High">High</option>
            <option value="Extreme">Extreme</option>
        </select>
    </div>
</div>

<!-- TABLE -->
<div class="table-wrap">
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Player</th>
                <th>Pos</th>
                <th>Team</th>
                <th>Age</th>
                <th>ETA</th>
                <th>Score</th>
                <th>Volatility</th>
                <th>Consensus</th>
                <th>Draft</th>
            </tr>
        </thead>
        <tbody id="tbody"></tbody>
    </table>
</div>

<!-- METHODOLOGY -->
<div class="method-section">
    <div class="method-card">
        <h3>Our Methodology</h3>
        <div class="method-grid">
            <div class="method-item">
                <h4>Percentile Normalization</h4>
                <p>Raw ranks are converted to a 0–100 scale using the formula <strong style="color:var(--accent-hi);">score = 100 × (1 − (rank−1) / (N−1))</strong>. This means #1 on a Top-100 list scores identically to #1 on a Top-500 list. Being in the top 10% of any list produces the same normalized score regardless of list length.</p>
            </div>
            <div class="method-item">
                <h4>Rankle Score</h4>
                <p>Each source's rankings are statistically normalized to account for differences in list length and depth. Scores are then combined using a proprietary weighting method that rewards broad consensus across multiple experts.</p>
            </div>
            <div class="method-item">
                <h4>Volatility (Standard Deviation)</h4>
                <p>Sample standard deviation of <strong style="color:var(--accent-hi);">Z-scores</strong> across sources. <strong style="color:var(--green);">Low (&lt;0.3)</strong> = sources agree. <strong style="color:#fbbf24;">Moderate (0.3–0.7)</strong> = some disagreement. <strong style="color:var(--red);">High (0.7–0.85)</strong> = significant divergence. <strong style="color:#a78bfa;">Extreme (≥0.85)</strong> = major outlier, single source or stark disagreement. Requires 2+ sources; single-source prospects are flagged.</p>
            </div>
        </div>
    </div>
</div>

<div class="fantasy-toast" id="fantasyToast"></div>

<!-- FOOTER -->
<footer>
    © 2026 Rankle. Rankings are transformative works aggregated from publicly available sources. We analyze data from MLB Pipeline, Baseball America, FanGraphs, Bleacher Report, ESPN, Just Baseball, RotoProspects, and Prospect361.
</footer>

<script>
// ============================================================
// RANKING ENGINE  — unit-tested & verified before deployment
// ============================================================

// Normalize a single rank to 0–100 given the source list length.
// rank 1 → 100, rank N → 0, linear between.
// ============================================================
// Z-SCORE ENGINE — "Rankle Score"
// Each source's ranks are converted to Z-scores using the
// theoretical mean and stddev of a 1..N uniform distribution.
// Z-scores are averaged across sources, then scaled to 0-100.
// ============================================================

// Precompute mean + stddev for a uniform 1..N list
function sourceStats(listLength) {
    const mean = (listLength + 1) / 2;
    const sd   = Math.sqrt((listLength * listLength - 1) / 12);
    return { mean, sd };
}

// Given player meta and an array of { source, rank, listLength },
// return the full computed prospect object.
function computeProspect(meta, sourceRankings) {
    const n = sourceRankings.length;
    if (n === 0) return { ...meta, sourceCount: 0, consensusAgreement: 0, rankleScore: 0, median: null, sd: null, volatility: "N/A" };

    // Convert each ranking to a Z-score
    const zScores  = sourceRankings.map(s => {
        const { mean, sd } = sourceStats(s.listLength);
        return -(s.rank - mean) / sd;   // negated: rank 1 = highest Z
    });
    const rawRanks = sourceRankings.map(s => s.rank);

    // Average Z across all sources
    const zAvg = zScores.reduce((a, b) => a + b, 0) / n;

    // Scale to 0-100 Rankle Score
    // Z range for a 100-item list is roughly -1.7 to +1.7
    // 50 + z*29.4 maps that to 0-100
    const rankleScore = Math.max(0, Math.min(100, 50 + zAvg * 29.4));

    // Median of raw ranks (intuitive reference)
    const sorted = [...rawRanks].sort((a, b) => a - b);
    const mid    = Math.floor(sorted.length / 2);
    const median = sorted.length % 2 !== 0
        ? sorted[mid]
        : (sorted[mid - 1] + sorted[mid]) / 2;

    // Volatility: stddev of Z-scores across sources
    let sd = null, volatility = "N/A";
    if (n >= 2) {
        const variance = zScores.reduce((sum, z) => sum + (z - zAvg) ** 2, 0) / (n - 1);
        sd = Math.sqrt(variance);
        volatility = sd < 0.3 ? "Low" : sd < 0.7 ? "Moderate" : sd < 0.85 ? "High" : "Extreme";
    }

    // Consensus (percentile band): count sources within ±10% of median percentile
    const CONSENSUS_BAND = 10;
    const percentiles = sourceRankings.map(s =>
        100 * (1 - (s.rank - 1) / (s.listLength - 1))
    );
    const sortedP = [...percentiles].sort((a, b) => a - b);
    const midP = Math.floor(sortedP.length / 2);
    const medianPercentile = sortedP.length % 2 !== 0
        ? sortedP[midP]
        : (sortedP[midP - 1] + sortedP[midP]) / 2;
    const consensusAgreement = percentiles.filter(p =>
        Math.abs(p - medianPercentile) <= CONSENSUS_BAND
    ).length;

    // Bayesian shrinkage: single-source players get pulled toward the mean (50).
    // More sources = more evidence = trust the score fully.
    // Formula: adjusted = (n * rawScore + k * 50) / (n + k), applied only when n === 1.
    // k=2 means a single-source score is weighted 1:2 against the prior mean.
    const K = 2;
    const penalizedScore = n === 1
        ? (rankleScore + K * 50) / (1 + K)
        : rankleScore;

    return { ...meta, sourceCount: n, consensusAgreement, rankleScore: Math.round(penalizedScore * 10) / 10, median, sd, volatility };
}

// ============================================================
// SOURCE DEFINITIONS
// Each source has its own list length — this is what makes
// normalization matter. Change these as you add real sources.
// ============================================================
const SOURCES = {
    pipeline:      { label: "MLB Pipeline",      listLength: 100 },
    ba:            { label: "Baseball America",  listLength: 100 },
    fangraphs:     { label: "FanGraphs",         listLength: 100 },
    br:            { label: "Bleacher Report",   listLength: 100 },
    espn:          { label: "ESPN",              listLength: 100 },
    justbaseball:  { label: "Just Baseball",     listLength: 100 },
    rotoprospects: { label: "RotoProspects",     listLength: 100 },
    prospect361:   { label: "Prospect361",       listLength: 100 },
    rotochamp:     { label: "RotoChamp",         listLength: 100 }
};

const RAW_DATA = [
    { name:"Konnor Griffin",        pos:"SS", team:"PIT", age:18, eta:"2027", ranks:{ pipeline:1, ba:1, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:1, prospect361:1, rotochamp:1 } },
    { name:"Kevin McGonigle",       pos:"SS", team:"DET", age:20, eta:"2027", ranks:{ pipeline:2, ba:2, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:3, prospect361:6, rotochamp:2 } },
    { name:"JJ Wetherholt",         pos:"2B", team:"STL", age:22, eta:"2026", ranks:{ pipeline:5, ba:3, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:5, prospect361:4, rotochamp:5 } },
    { name:"Jesus Made",            pos:"SS", team:"MIL", age:17, eta:"2027", ranks:{ pipeline:3, ba:4, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:2, prospect361:2, rotochamp:3 } },
    { name:"Walker Jenkins",        pos:"OF", team:"MIN", age:19, eta:"2027", ranks:{ pipeline:14, ba:5, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:4, prospect361:5, rotochamp:14 } },
    { name:"Max Clark",             pos:"OF", team:"DET", age:20, eta:"2027", ranks:{ pipeline:10, ba:6, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:11, prospect361:3, rotochamp:10 } },
    { name:"Colt Emerson",          pos:"SS", team:"SEA", age:19, eta:"2027", ranks:{ pipeline:9, ba:7, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:15, prospect361:17, rotochamp:9 } },
    { name:"Nolan McLean",          pos:"SP", team:"NYM", age:23, eta:"2026", ranks:{ pipeline:6, ba:8, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:10, prospect361:23, rotochamp:6 } },
    { name:"Samuel Basallo",        pos:"1B", team:"BAL", age:20, eta:"2027", ranks:{ pipeline:8, ba:9, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:8, prospect361:7, rotochamp:8 } },
    { name:"Trey Yesavage",         pos:"SP", team:"TOR", age:21, eta:"2027", ranks:{ pipeline:12, ba:10, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:13, prospect361:28, rotochamp:12 } },
    { name:"Carter Jensen",         pos:"1B", team:"KC", age:21, eta:"2027", ranks:{ pipeline:18, ba:11, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:24, prospect361:59, rotochamp:18 } },
    { name:"Leo De Vries",          pos:"SS", team:"ATH", age:18, eta:"2027", ranks:{ pipeline:4, ba:12, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:6, prospect361:12, rotochamp:4 } },
    { name:"Thomas White",          pos:"SP", team:"MIA", age:20, eta:"2027", ranks:{ pipeline:17, ba:13, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:16, prospect361:27, rotochamp:17 } },
    { name:"Aidan Miller",          pos:"SS", team:"PHI", age:20, eta:"2027", ranks:{ pipeline:23, ba:14, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:14, prospect361:9, rotochamp:23 } },
    { name:"Bubba Chandler",        pos:"SP", team:"PIT", age:22, eta:"2026", ranks:{ pipeline:11, ba:15, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:12, prospect361:10, rotochamp:11 } },
    { name:"Sebastian Walcott",     pos:"SS", team:"TEX", age:18, eta:"2027", ranks:{ pipeline:7, ba:16, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:7, prospect361:8, rotochamp:7 } },
    { name:"Payton Tolle",          pos:"SP", team:"BOS", age:22, eta:"2026", ranks:{ pipeline:19, ba:17, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:33, prospect361:41, rotochamp:19 } },
    { name:"Bryce Eldridge",        pos:"1B", team:"SF", age:20, eta:"2027", ranks:{ pipeline:25, ba:18, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:19, prospect361:18, rotochamp:25 } },
    { name:"Carson Benge",          pos:"OF", team:"NYM", age:22, eta:"2026", ranks:{ pipeline:16, ba:19, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:17, prospect361:32, rotochamp:16 } },
    { name:"Eduardo Quintero",      pos:"OF", team:"LAD", age:19, eta:"2027", ranks:{ pipeline:30, ba:20, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:22, prospect361:20, rotochamp:30 } },
    { name:"Dylan Beavers",         pos:"OF", team:"BAL", age:23, eta:"2026", ranks:{ pipeline:69, ba:21, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:25, prospect361:null, rotochamp:69 } },
    { name:"Travis Bazzana",        pos:"2B", team:"CLE", age:22, eta:"2026", ranks:{ pipeline:20, ba:22, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:28, prospect361:73, rotochamp:20 } },
    { name:"Sal Stewart",           pos:"1B", team:"CIN", age:21, eta:"2027", ranks:{ pipeline:22, ba:23, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:9, prospect361:44, rotochamp:22 } },
    { name:"Josue De Paula",        pos:"OF", team:"LAD", age:19, eta:"2027", ranks:{ pipeline:15, ba:24, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:21, prospect361:11, rotochamp:15 } },
    { name:"Kade Anderson",         pos:"SP", team:"SEA", age:19, eta:"2027", ranks:{ pipeline:21, ba:25, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:36, prospect361:21, rotochamp:21 } },
    { name:"Noah Schultz",          pos:"SP", team:"CHW", age:21, eta:"2027", ranks:{ pipeline:49, ba:26, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:84, prospect361:74, rotochamp:49 } },
    { name:"Caleb Bonemer",         pos:"SS", team:"CHW", age:19, eta:"2027", ranks:{ pipeline:61, ba:27, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:45, prospect361:null, rotochamp:61 } },
    { name:"Edward Florentino",     pos:"OF", team:"PIT", age:18, eta:"2027", ranks:{ pipeline:50, ba:28, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:23, prospect361:96, rotochamp:50 } },
    { name:"Bryce Rainer",          pos:"SS", team:"DET", age:19, eta:"2027", ranks:{ pipeline:35, ba:29, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:26, prospect361:24, rotochamp:35 } },
    { name:"Josuar Gonzalez",       pos:"SS", team:"SF", age:19, eta:"2027", ranks:{ pipeline:44, ba:30, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:49, prospect361:69, rotochamp:44 } },
    { name:"Eli Willits",           pos:"SS", team:"WAS", age:19, eta:"2027", ranks:{ pipeline:13, ba:31, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:41, prospect361:66, rotochamp:13 } },
    { name:"Andrew Painter",        pos:"SP", team:"PHI", age:21, eta:"2027", ranks:{ pipeline:28, ba:32, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:38, prospect361:13, rotochamp:28 } },
    { name:"Liam Doyle",            pos:"SP", team:"STL", age:19, eta:"2027", ranks:{ pipeline:34, ba:33, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:70, prospect361:33, rotochamp:34 } },
    { name:"Chase DeLauter",        pos:"OF", team:"CLE", age:23, eta:"2026", ranks:{ pipeline:46, ba:34, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:72, prospect361:86, rotochamp:46 } },
    { name:"Rainiel Rodriguez",     pos:"OF", team:"MIN", age:21, eta:"2027", ranks:{ pipeline:82, ba:59, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:64, prospect361:83, rotochamp:74 } },
    { name:"Moises Ballesteros",    pos:"1B", team:"CHC", age:21, eta:"2027", ranks:{ pipeline:55, ba:36, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:37, prospect361:25, rotochamp:55 } },
    { name:"Brody Hopkins",         pos:"SP", team:"TB", age:23, eta:"2026", ranks:{ pipeline:85, ba:37, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:53, prospect361:null, rotochamp:85 } },
    { name:"Seth Hernandez",        pos:"SP", team:"PIT", age:19, eta:"2027", ranks:{ pipeline:29, ba:38, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:61, prospect361:34, rotochamp:29 } },
    { name:"Jamie Arnold",          pos:"SP", team:"ATH", age:19, eta:"2027", ranks:{ pipeline:41, ba:39, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:71, prospect361:null, rotochamp:41 } },
    { name:"Gage Jump",             pos:"SP", team:"ATH", age:21, eta:"2027", ranks:{ pipeline:57, ba:40, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:48, rotochamp:57 } },
    { name:"Robby Snelling",        pos:"SP", team:"MIA", age:21, eta:"2027", ranks:{ pipeline:39, ba:41, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:32, prospect361:35, rotochamp:39 } },
    { name:"Aiva Arquette",         pos:"SS", team:"MIA", age:21, eta:"2027", ranks:{ pipeline:47, ba:42, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:68, prospect361:67, rotochamp:47 } },
    { name:"Owen Caissie",          pos:"OF", team:"MIA", age:22, eta:"2026", ranks:{ pipeline:42, ba:43, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:35, prospect361:null, rotochamp:42 } },
    { name:"Jonah Tong",            pos:"SP", team:"NYM", age:21, eta:"2027", ranks:{ pipeline:48, ba:44, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:20, prospect361:26, rotochamp:48 } },
    { name:"Mike Sirota",           pos:"OF", team:"LAD", age:21, eta:"2027", ranks:{ pipeline:60, ba:45, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:44, prospect361:97, rotochamp:60 } },
    { name:"George Lombard",        pos:"SS", team:"NYY", age:19, eta:"2027", ranks:{ pipeline:32, ba:46, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:55, prospect361:37, rotochamp:32 } },
    { name:"Luis Pena",             pos:"SS", team:"MIL", age:18, eta:"2027", ranks:{ pipeline:26, ba:47, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:31, prospect361:15, rotochamp:26 } },
    { name:"Ryan Waldschmidt",      pos:"OF", team:"ARI", age:22, eta:"2026", ranks:{ pipeline:59, ba:48, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:29, prospect361:46, rotochamp:59 } },
    { name:"Franklin Arias",        pos:"SS", team:"BOS", age:19, eta:"2027", ranks:{ pipeline:31, ba:49, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:75, prospect361:14, rotochamp:31 } },
    { name:"Cooper Pratt",          pos:"SS", team:"MIL", age:20, eta:"2027", ranks:{ pipeline:64, ba:50, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:65, prospect361:58, rotochamp:64 } },
    { name:"Tyler Bremner",         pos:"SP", team:"LAA", age:20, eta:"2027", ranks:{ pipeline:81, ba:51, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:89, prospect361:null, rotochamp:81 } },
    { name:"Connelly Early",        pos:"SP", team:"BOS", age:22, eta:"2026", ranks:{ pipeline:56, ba:52, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:34, prospect361:55, rotochamp:56 } },
    { name:"Cam Caminiti",          pos:"SP", team:"ATL", age:18, eta:"2027", ranks:{ pipeline:68, ba:53, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:86, prospect361:null, rotochamp:68 } },
    { name:"Joshua Baez",           pos:"OF", team:"STL", age:21, eta:"2027", ranks:{ pipeline:87, ba:54, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:18, prospect361:61, rotochamp:87 } },
    { name:"Joe Mack",              pos:"C", team:"MIA", age:22, eta:"2026", ranks:{ pipeline:62, ba:55, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:97, prospect361:null, rotochamp:62 } },
    { name:"Ralphy Velazquez",      pos:"1B", team:"CLE", age:19, eta:"2027", ranks:{ pipeline:89, ba:56, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:89 } },
    { name:"Lazaro Montes",         pos:"OF", team:"SEA", age:20, eta:"2027", ranks:{ pipeline:43, ba:58, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:46, prospect361:45, rotochamp:43 } },
    { name:"Ryan Sloan",            pos:"SP", team:"SEA", age:19, eta:"2027", ranks:{ pipeline:33, ba:60, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:48, prospect361:52, rotochamp:33 } },
    { name:"Dax Kilby",             pos:"SS", team:"NYY", age:19, eta:"2027", ranks:{ pipeline:94, ba:61, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:56, prospect361:null, rotochamp:94 } },
    { name:"Arjun Nimmala",         pos:"SS", team:"TOR", age:19, eta:"2027", ranks:{ pipeline:77, ba:62, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:66, prospect361:39, rotochamp:77 } },
    { name:"Zyhir Hope",            pos:"OF", team:"LAD", age:20, eta:"2027", ranks:{ pipeline:27, ba:63, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:58, prospect361:16, rotochamp:27 } },
    { name:"Theo Gillen",           pos:"OF", team:"TB", age:19, eta:"2027", ranks:{ pipeline:76, ba:64, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:40, rotochamp:76 } },
    { name:"Caden Scarborough",     pos:"SP", team:"TEX", age:20, eta:"2027", ranks:{ pipeline:null, ba:65, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:95, prospect361:null, rotochamp:null } },
    { name:"JoJo Parker",           pos:"SS", team:"TOR", age:19, eta:"2027", ranks:{ pipeline:45, ba:66, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:69, prospect361:51, rotochamp:45 } },
    { name:"Angel Genao",           pos:"SS", team:"CLE", age:20, eta:"2027", ranks:{ pipeline:66, ba:67, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:76, prospect361:57, rotochamp:66 } },
    { name:"Jarlin Susana",         pos:"SP", team:"WAS", age:20, eta:"2027", ranks:{ pipeline:80, ba:68, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:67, prospect361:null, rotochamp:80 } },
    { name:"Kyson Witherspoon",     pos:"SP", team:"BOS", age:19, eta:"2027", ranks:{ pipeline:84, ba:69, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:88, prospect361:75, rotochamp:84 } },
    { name:"Jacob Melton",          pos:"OF", team:"TB", age:25, eta:"2027", ranks:{ pipeline:null, ba:70, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:79, prospect361:89, rotochamp:null } },
    { name:"Jett Williams",         pos:"SS", team:"TB", age:21, eta:"2027", ranks:{ pipeline:63, ba:85, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:51, prospect361:50, rotochamp:63 } },
    { name:"Trey Gibson",           pos:"SP", team:"BAL", age:23, eta:"2027", ranks:{ pipeline:null, ba:72, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:96, prospect361:null, rotochamp:null } },
    { name:"Braden Montgomery",     pos:"OF", team:"CHW", age:21, eta:"2027", ranks:{ pipeline:36, ba:73, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:42, prospect361:49, rotochamp:36 } },
    { name:"Kaelen Culpepper",      pos:"SS", team:"MIN", age:22, eta:"2026", ranks:{ pipeline:52, ba:74, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:50, prospect361:30, rotochamp:52 } },
    { name:"Justin Crawford",       pos:"OF", team:"PHI", age:21, eta:"2027", ranks:{ pipeline:53, ba:75, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:78, prospect361:38, rotochamp:53 } },
    { name:"Josue Briceno",         pos:"C", team:"DET", age:20, eta:"2027", ranks:{ pipeline:40, ba:76, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:54, prospect361:22, rotochamp:40 } },
    { name:"Alfredo Duno",          pos:"C", team:"CIN", age:19, eta:"2027", ranks:{ pipeline:38, ba:77, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:47, prospect361:56, rotochamp:38 } },
    { name:"Jaxon Wiggins",         pos:"SP", team:"CHC", age:23, eta:"2026", ranks:{ pipeline:58, ba:78, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:80, prospect361:null, rotochamp:58 } },
    { name:"Rhett Lowder",          pos:"SP", team:"CIN", age:22, eta:"2026", ranks:{ pipeline:86, ba:79, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:86 } },
    { name:"Ethan Holliday",        pos:"SS", team:"COL", age:19, eta:"2027", ranks:{ pipeline:24, ba:80, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:57, prospect361:19, rotochamp:24 } },
    { name:"Brandon Sproat",        pos:"SP", team:"MIL", age:24, eta:"2026", ranks:{ pipeline:100, ba:81, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:62, prospect361:43, rotochamp:100 } },
    { name:"Kendry Chourio",        pos:"SP", team:"KC", age:19, eta:"2027", ranks:{ pipeline:null, ba:82, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:98, prospect361:null, rotochamp:null } },
    { name:"A.J. Ewing",            pos:"OF", team:"NYM", age:20, eta:"2027", ranks:{ pipeline:97, ba:83, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:83, prospect361:71, rotochamp:97 } },
    { name:"JR Ritchie",            pos:"SP", team:"ATL", age:21, eta:"2027", ranks:{ pipeline:90, ba:84, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:91, prospect361:84, rotochamp:90 } },
    { name:"Nate George",           pos:"OF", team:"BAL", age:19, eta:"2027", ranks:{ pipeline:93, ba:86, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:74, prospect361:null, rotochamp:93 } },
    { name:"Bo Davidson",           pos:"OF", team:"SF", age:23, eta:"2027", ranks:{ pipeline:null, ba:87, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:82, prospect361:null, rotochamp:null } },
    { name:"Parker Messick",        pos:"SP", team:"CLE", age:24, eta:"2026", ranks:{ pipeline:95, ba:88, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:95 } },
    { name:"Braylon Doughty",       pos:"RHP", team:"CLE", age:20, eta:"2027", ranks:{ pipeline:null, ba:89, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:null } },
    { name:"Ethan Salas",           pos:"C", team:"SD", age:19, eta:"2027", ranks:{ pipeline:null, ba:90, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:79, rotochamp:null } },
    { name:"Hagen Smith",           pos:"SP", team:"CHW", age:21, eta:"2027", ranks:{ pipeline:72, ba:91, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:85, prospect361:null, rotochamp:72 } },
    { name:"Billy Carlson",         pos:"SS", team:"CHW", age:19, eta:"2027", ranks:{ pipeline:73, ba:92, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:73 } },
    { name:"Carlos Lagrange",       pos:"SP", team:"NYY", age:21, eta:"2027", ranks:{ pipeline:79, ba:93, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:81, prospect361:100, rotochamp:79 } },
    { name:"Connor Prielipp",       pos:"LHP", team:"MIN", age:25, eta:"2027", ranks:{ pipeline:null, ba:94, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:null } },
    { name:"Luis De Leon",          pos:"SP", team:"BAL", age:22, eta:"2027", ranks:{ pipeline:null, ba:95, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:100, prospect361:null, rotochamp:null } },
    { name:"Logan Henderson",       pos:"SP", team:"MIL", age:23, eta:"2027", ranks:{ pipeline:null, ba:96, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:90, prospect361:null, rotochamp:null } },
    { name:"Kayson Cunningham",     pos:"SS", team:"ARI", age:19, eta:"2027", ranks:{ pipeline:null, ba:97, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:null } },
    { name:"Jhonny Level",          pos:"SS", team:"SF", age:19, eta:"2027", ranks:{ pipeline:null, ba:98, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:81, rotochamp:null } },
    { name:"Harry Ford",            pos:"C", team:"WAS", age:21, eta:"2027", ranks:{ pipeline:71, ba:99, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:42, rotochamp:71 } },
    { name:"Tanner McDougal",       pos:"RHP", team:"CWS", age:22, eta:"2027", ranks:{ pipeline:null, ba:100, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:null } },
    { name:"Travis Sykora",         pos:"SP", team:"WAS", age:20, eta:"2027", ranks:{ pipeline:54, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:64, rotochamp:54 } },
    { name:"Eduardo Tait",          pos:"C", team:"MIN", age:18, eta:"2027", ranks:{ pipeline:65, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:76, rotochamp:65 } },
    { name:"Michael Arroyo",        pos:"2B", team:"SEA", age:20, eta:"2027", ranks:{ pipeline:67, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:87, prospect361:82, rotochamp:67 } },
    { name:"Charlie Condon",        pos:"1B", team:"COL", age:21, eta:"2027", ranks:{ pipeline:70, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:60, rotochamp:70 } },
    { name:"Blake Mitchell",        pos:"C", team:"KC", age:20, eta:"2027", ranks:{ pipeline:75, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:75 } },
    { name:"Jonny Farmelo",         pos:"OF", team:"SEA", age:20, eta:"2027", ranks:{ pipeline:78, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:93, prospect361:92, rotochamp:78 } },
    { name:"Steele Hall",           pos:"SS", team:"CIN", age:19, eta:"2027", ranks:{ pipeline:83, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:60, prospect361:null, rotochamp:83 } },
    { name:"Kruz Schoolcraft",      pos:"SP", team:"SD", age:19, eta:"2027", ranks:{ pipeline:88, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:88 } },
    { name:"Jurrangelo Cijntje",    pos:"SP", team:"SEA", age:21, eta:"2027", ranks:{ pipeline:91, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:70, rotochamp:91 } },
    { name:"Emil Morales",          pos:"SS", team:"LAD", age:18, eta:"2027", ranks:{ pipeline:92, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:92 } },
    { name:"Hunter Barco",          pos:"SP", team:"PIT", age:24, eta:"2026", ranks:{ pipeline:96, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:96 } },
    { name:"Leonardo Bernal",       pos:"C", team:"STL", age:20, eta:"2027", ranks:{ pipeline:98, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:null, rotochamp:98 } },
    { name:"Cooper Ingle",          pos:"C", team:"CLE", age:22, eta:"2026", ranks:{ pipeline:99, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:99, rotochamp:99 } },
    { name:"Tatsuya Imai",          pos:"SP", team:"HOU", age:27, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:39, prospect361:31, rotochamp:null } },
    { name:"Munetaka Murakami",     pos:"1B", team:"CHW", age:26, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:40, prospect361:null, rotochamp:null } },
    { name:"Ralphy Velasquez",      pos:"C", team:"CLE", age:19, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:43, prospect361:null, rotochamp:null } },
    { name:"Spencer Jones",         pos:"OF", team:"NYY", age:24, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:59, prospect361:85, rotochamp:null } },
    { name:"Ryan Clifford",         pos:"1B", team:"NYM", age:22, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:63, prospect361:null, rotochamp:null } },
    { name:"Andrew Fischer",        pos:"3B", team:"MIL", age:19, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:73, prospect361:null, rotochamp:null } },
    { name:"Brice Matthews",        pos:"SS", team:"HOU", age:23, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:77, prospect361:null, rotochamp:null } },
    { name:"Jacob Reimer",          pos:"3B", team:"NYM", age:21, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:92, prospect361:null, rotochamp:null } },
    { name:"Kazuma Okamoto",        pos:"1B", team:"TOR", age:29, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:94, prospect361:47, rotochamp:null } },
    { name:"Zach Cole",             pos:"OF", team:"HOU", age:25, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:99, prospect361:null, rotochamp:null } },
    { name:"Felnin Celesten",       pos:"SS", team:"SEA", age:20, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:36, rotochamp:null } },
    { name:"Jeferson Quero",        pos:"C", team:"MIL", age:23, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:53, rotochamp:null } },
    { name:"Ike Irish",             pos:"C", team:"BAL", age:19, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:54, rotochamp:null } },
    { name:"Elmer Rodriguez-Cruz",  pos:"SP", team:"NYY", age:21, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:52, prospect361:62, rotochamp:82 } },
    { name:"Slade Caldwell",        pos:"OF", team:"ARI", age:19, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:63, rotochamp:null } },
    { name:"Termarr Johnson",       pos:"SS", team:"PIT", age:21, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:65, rotochamp:null } },
    { name:"Jhostynxon Garcia",     pos:"OF", team:"PIT", age:23, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:68, rotochamp:null } },
    { name:"Aroon Escobar",         pos:"3B", team:"PHI", age:21, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:72, rotochamp:null } },
    { name:"Jaden Hamm",            pos:"RHP", team:"DET", age:23, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:77, rotochamp:null } },
    { name:"Staryln Caba",          pos:"SS", team:"MIA", age:19, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:78, rotochamp:null } },
    { name:"Cole Carrigg",          pos:"OF", team:"COL", age:23, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:80, rotochamp:null } },
    { name:"River Ryan",            pos:"RHP", team:"LAD", age:27, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:87, rotochamp:null } },
    { name:"Wehiwa Aloy",           pos:"SS", team:"BAL", age:19, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:88, rotochamp:null } },
    { name:"Tink Hence",            pos:"RHP", team:"STL", age:23, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:90, rotochamp:null } },
    { name:"Welbyn Francisca",      pos:"SS", team:"CLE", age:19, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:91, rotochamp:null } },
    { name:"Tommy Troy",            pos:"3B", team:"ARI", age:24, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:93, rotochamp:null } },
    { name:"Ricky Tiedemann",       pos:"LHP", team:"TOR", age:23, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:94, rotochamp:null } },
    { name:"Marek Houston",         pos:"SS", team:"MIN", age:19, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:95, rotochamp:null } },
    { name:"Xavier Isaac",          pos:"1B", team:"TB", age:22, eta:"2027", ranks:{ pipeline:null, ba:null, fangraphs:null, br:null, espn:null, justbaseball:null, rotoprospects:null, prospect361:98, rotochamp:null } }
];

// ============================================================
// BUILD + SORT
// ============================================================
function buildProspects() {
    return RAW_DATA.map(row => {
        const sourceRankings = [];
        for (const [key, val] of Object.entries(row.ranks)) {
            if (val !== null) {
                sourceRankings.push({ source: key, rank: val, listLength: SOURCES[key].listLength });
            }
        }
        return computeProspect(
            { name: row.name, pos: row.pos, team: row.team, age: row.age, eta: row.eta },
            sourceRankings
        );
    })
    .sort((a, b) => b.rankleScore - a.rankleScore)     // primary: Rankle Score descending
    .map((p, i) => ({ ...p, displayRank: i + 1 }));   // assign final display rank
}

const ALL_PROSPECTS = buildProspects();
const FREE_LIMIT    = 999;  // ← no paywall during development

// ============================================================
// FANTASY LEAGUE OWNERSHIP (temporary, sessionStorage)
// ============================================================
const FANTASY_STORAGE = 'rankle-fantasy-csv';

function looksLikeMlbTeam(s) {
    const v = (s || '').trim();
    if (!v || v.length > 6) return false;
    return /^[A-Z]{2,3}$/i.test(v) || /^(tb|sd|sf|la|nyy|nym|chw|chc|kc|stl|ari|atl|bal|bos|cle|col|det|hou|mil|min|oak|sea|tex|tor|was|wsh|mia|phi|cws|cin)$/i.test(v);
}

function looksLikeId(s) {
    const v = (s || '').trim();
    if (!v || v.length < 8) return false;
    return /^[0-9a-f]{8,}$/i.test(v) || (/^[a-z0-9]{10,}$/i.test(v) && !/[aeiou]/i.test(v));
}

function looksLikePercentOrStat(s) {
    const v = (s || '').trim();
    if (!v) return false;
    if (/%$/.test(v)) return true;
    const n = parseFloat(v.replace(/%/g, ''));
    return !isNaN(n) && v.replace(/[\d.\s%]/g, '').length === 0;
}

function parseCsvLine(line, sep) {
    if (sep === '\t') return line.split(sep).map(c => c.replace(/^"|"$/g, '').trim());
    const out = [];
    let cur = '', inQuote = false;
    for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (ch === '"') inQuote = !inQuote;
        else if (ch === ',' && !inQuote) {
            out.push(cur.replace(/^"|"$/g, '').trim());
            cur = '';
        } else cur += ch;
    }
    out.push(cur.replace(/^"|"$/g, '').trim());
    return out;
}

function parseFantasyCsv(text) {
    const lines = text.trim().split(/[\r\n]+/).filter(l => l.trim());
    if (lines.length < 2) return {};
    const sep = lines[0].includes('\t') ? '\t' : ',';
    const cols = parseCsvLine(lines[0], sep).map(c => c.toLowerCase());
    const parseRow = i => parseCsvLine(lines[i], sep);

    let playerIdx = cols.findIndex(c => /^player$|^name$|^hitter$|^pitcher$/.test(c));
    if (playerIdx === -1) playerIdx = cols.findIndex(c => c.includes('player') || c.includes('name'));
    if (playerIdx === -1) playerIdx = 0;

    const statHeaders = /^(pos|position|slot|elig|ab|hr|rbi|avg|ip|k|whip|era|sv|id|player.?id|owned|owned.?%|own.?%|ownership|%|pct)$/i;
    const ownerHeaders = /^owner$|^fantasy|^fantasy.?team$|^team.?owner$|^manager$|^owned.?by$|^drafted.?by$|^franchise$|^gm$/;

    let ownerIdx = -1;
    const statusIdx = cols.findIndex(c => /^status$/i.test(c));
    if (statusIdx >= 0) {
        const statusVals = [];
        for (let r = 1; r < Math.min(lines.length, 51); r++) {
            const v = (parseRow(r)[statusIdx] || '').trim();
            if (v) statusVals.push(v);
        }
        const hasFa = statusVals.some(v => /^fa$/i.test(v));
        const valid = statusVals.filter(v => !looksLikePercentOrStat(v)).length;
        if (hasFa || valid >= statusVals.length * 0.8) ownerIdx = statusIdx;
    }
    let bestScore = -1;

    for (let c = 0; c < cols.length && ownerIdx === -1; c++) {
        if (c === playerIdx || statHeaders.test(cols[c])) continue;
        const vals = [];
        for (let r = 1; r < Math.min(lines.length, 101); r++) {
            const v = (parseRow(r)[c] || '').trim();
            if (v) vals.push(v);
        }
        if (vals.length < 3) continue;

        const mlbLike = vals.filter(v => looksLikeMlbTeam(v)).length;
        const idLike = vals.filter(v => looksLikeId(v)).length;
        const percentLike = vals.filter(v => looksLikePercentOrStat(v)).length;
        const validVals = vals.filter(v => !looksLikeMlbTeam(v) && !looksLikeId(v) && !looksLikePercentOrStat(v));
        const unique = new Set(validVals).size;

        if (mlbLike >= vals.length * 0.6) continue;
        if (idLike >= vals.length * 0.4) continue;
        if (percentLike >= vals.length * 0.5) continue;
        if (unique < 2 || unique > vals.length * 0.95) continue;

        const leagueSized = unique >= 3 && unique <= 24;
        const headerMatch = ownerHeaders.test(cols[c]);
        const teamHeaderOk = /^team$/.test(cols[c]) && mlbLike < vals.length * 0.3;

        let score = validVals.length * 2 + unique;
        if (headerMatch) score += 500;
        else if (teamHeaderOk) score += 50;
        if (leagueSized) score += 100;

        if (score > bestScore) {
            bestScore = score;
            ownerIdx = c;
        }
    }

    if (ownerIdx === -1) {
        const explicit = cols.findIndex(c => ownerHeaders.test(c) && !statHeaders.test(c));
        if (explicit >= 0) {
            const exVals = [];
            for (let r = 1; r < Math.min(lines.length, 21); r++) {
                const v = (parseRow(r)[explicit] || '').trim();
                if (v) exVals.push(v);
            }
            if (exVals.filter(v => looksLikePercentOrStat(v)).length < exVals.length * 0.5) ownerIdx = explicit;
        }
        if (ownerIdx === -1) ownerIdx = cols.length > 2 ? cols.length - 1 : 1;
    }

    const map = {};
    for (let i = 1; i < lines.length; i++) {
        const cells = parseRow(i);
        const name = (cells[playerIdx] || '').trim();
        const owner = (cells[ownerIdx] || '').trim();
        if (!name) continue;
        const ownerUpper = owner.toUpperCase();
        if (ownerUpper === 'FA' || /^fa$/i.test(owner)) continue;
        if (ownerIdx !== statusIdx && (looksLikeMlbTeam(owner) || looksLikePercentOrStat(owner))) continue;
        if (!owner || owner.length < 1) continue;
        const n = normalizeName(name);
        map[n] = owner;
    }
    return map;
}

function normalizeName(s) {
    return s.replace(/\s+/g, ' ').trim().toLowerCase();
}

function lastNameFromParts(parts) {
    if (!parts.length) return '';
    const last = parts[parts.length - 1]?.toLowerCase() || '';
    const suffix = /^(jr\.?|iii?|iv|ii|sr\.?)$/i.test(last);
    return suffix && parts.length >= 2 ? parts[parts.length - 2]?.toLowerCase() || '' : last;
}

function fuzzyMatchProspect(prospectName, ownershipMap) {
    const n = normalizeName(prospectName);
    if (ownershipMap[n]) return ownershipMap[n];
    const prospectParts = prospectName.trim().split(/\s+/);
    const prospectFirst = prospectParts[0]?.toLowerCase() || '';
    const prospectLast = lastNameFromParts(prospectParts);
    const prospectInitial = prospectFirst.charAt(0);
    for (const [k, v] of Object.entries(ownershipMap)) {
        const csvParts = k.trim().split(/\s+/);
        const csvLast = lastNameFromParts(csvParts);
        const csvFirst = csvParts[0]?.toLowerCase() || '';
        if (csvLast !== prospectLast) continue;
        const csvInitial = csvFirst.charAt(0);
        if (prospectInitial && csvInitial && prospectInitial !== csvInitial) continue;
        return v;
    }
    return null;
}

let ownershipMap = {};

function applyFantasyCsv(text, opts) {
    text = (text || '').trim();
    if (!text) return;
    ownershipMap = parseFantasyCsv(text);
    sessionStorage.setItem(FANTASY_STORAGE, text);
    const btn = document.getElementById('btnUploadRoster');
    if (btn) { btn.textContent = 'Roster loaded ✓'; btn.classList.add('loaded'); }
    render();

    if (opts?.skipClose !== true) {
        document.getElementById('fantasySection').classList.remove('open');
    }

    const toast = document.getElementById('fantasyToast');
    toast.innerHTML = 'Roster imported successfully.';
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3500);
}

function processAndApplyCsv(text) {
    const zone = document.getElementById('fantasyDropZone');
    const bar = document.getElementById('fantasyProgressBar');

    zone.classList.remove('success');
    zone.classList.add('processing');
    bar.style.width = '0%';

    // Animate loading bar 0 -> 100% over ~500ms
    const duration = 500;
    const start = performance.now();
    function tick(now) {
        const elapsed = now - start;
        const pct = Math.min((elapsed / duration) * 100, 100);
        bar.style.width = pct + '%';

        if (pct < 100) {
            requestAnimationFrame(tick);
            return;
        }

        // Bar complete: apply data and show success
        applyFantasyCsv(text, { skipClose: true });

        zone.classList.remove('processing');
        zone.classList.add('success');

        // Close section and reset after showing checkmark
        setTimeout(() => {
            document.getElementById('fantasySection').classList.remove('open');
            zone.classList.remove('success');
            bar.style.width = '0%';
        }, 1400);
    }
    requestAnimationFrame(tick);
}

(function loadFantasyFromStorage() {
    const saved = sessionStorage.getItem(FANTASY_STORAGE);
    if (saved) {
        ownershipMap = parseFantasyCsv(saved);
        const btn = document.getElementById('btnUploadRoster');
        if (btn) { btn.textContent = 'Roster loaded ✓'; btn.classList.add('loaded'); }
    }
})();

// ============================================================
// MLB DRAFT / SIGNING YEAR (from MLB Stats API)
// ============================================================
const DRAFT_YEARS = [2018, 2019, 2020, 2021, 2022, 2023, 2024, 2025];
let draftMap = new Map(); // normalized name -> draft year

// Temporary static IFA signing years (Spotrac/BA; remove when done)
const IFA_SIGNINGS = { "jesus made":2024,"leo de vries":2024,"leodalis de vries":2024,"emil morales":2024,"jhonny level":2024,"luis pena":2024,"edward florentino":2024,"samuel basallo":2022,"josue de paula":2022,"eduardo quintero":2023,"sebastian walcott":2023,"ethan salas":2023,"moises ballesteros":2019,"josuar gonzalez":2023,"alfredo duno":2023,"ralphy velazquez":2023,"felnin celesten":2023,"lazaro montes":2021,"jarlin susana":2022,"kendry chourio":2023,"michael arroyo":2022,"jeferson quero":2019,"leonardo bernal":2021,"joshua baez":2021,"franklin arias":2023,"cooper pratt":2023,"angel genao":2022,"josue briceno":2022 };

function normalizeDraftName(s) {
    if (!s || typeof s !== 'string') return '';
    return s.toLowerCase()
        .replace(/\./g, '')
        .replace(/\s+/g, ' ')
        .replace(/\s*(jr\.?|iii?|iv|ii)\s*$/i, '')
        .trim();
}

function getDraftYear(prospectName) {
    const n = normalizeDraftName(prospectName);
    if (draftMap.has(n)) return draftMap.get(n);
    const yr = IFA_SIGNINGS[n];
    if (yr) return "IFA '" + String(yr).slice(-2);
    const parts = prospectName.trim().split(/\s+/).filter(Boolean);
    if (parts.length >= 2) {
        const lastFirst = (parts[parts.length - 1] + ' ' + parts[0]).toLowerCase().replace(/\./g, '');
        if (draftMap.has(lastFirst)) return draftMap.get(lastFirst);
        const firstLast = (parts[0] + ' ' + parts[parts.length - 1]).toLowerCase().replace(/\./g, '');
        if (draftMap.has(firstLast)) return draftMap.get(firstLast);
        if (IFA_SIGNINGS[lastFirst]) return "IFA '" + String(IFA_SIGNINGS[lastFirst]).slice(-2);
        if (IFA_SIGNINGS[firstLast]) return "IFA '" + String(IFA_SIGNINGS[firstLast]).slice(-2);
    }
    return null;
}

async function loadDraftMap() {
    const yearData = await Promise.all(
        DRAFT_YEARS.map(async (year) => {
            try {
                const res = await fetch(`https://statsapi.mlb.com/api/v1/draft/prospects/${year}`);
                const data = await res.json();
                return { year, prospects: data.prospects || [] };
            } catch (e) {
                console.warn('MLB draft fetch failed for', year, e);
                return { year, prospects: [] };
            }
        })
    );
    for (const { year, prospects } of yearData) {
        for (const p of prospects) {
            if (!p.isDrafted || !p.person?.fullName) continue;
            const yr = p.year ?? p.person.draftYear ?? year;
            const name = p.person.fullName;
            const n = normalizeDraftName(name);
            const existing = draftMap.get(n);
            if (existing == null || yr > existing) draftMap.set(n, yr);
            const first = (p.person.firstName || '').replace(/\./g, '');
            const last = (p.person.lastName || '').replace(/\./g, '');
            if (first && last) {
                const fl = (first + ' ' + last).toLowerCase().replace(/\s+/g, ' ');
                const lf = (last + ' ' + first).toLowerCase().replace(/\s+/g, ' ');
                if (draftMap.get(fl) == null || yr > draftMap.get(fl)) draftMap.set(fl, yr);
                if (draftMap.get(lf) == null || yr > draftMap.get(lf)) draftMap.set(lf, yr);
            }
        }
    }
    if (typeof render === 'function') render();
}

(function setupFantasyDropZone() {
    const zone = document.getElementById('fantasyDropZone');
    ['dragenter', 'dragover'].forEach(ev => {
        zone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); zone.classList.add('drag-over'); });
    });
    ['dragleave', 'drop'].forEach(ev => {
        zone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); zone.classList.remove('drag-over'); });
    });
    zone.addEventListener('drop', e => {
        const file = e.dataTransfer?.files?.[0];
        if (!file) return;
        if (!/\.(csv|txt)$/i.test(file.name) && !file.type.match(/text\/|csv/)) return;
        const reader = new FileReader();
        reader.onload = () => processAndApplyCsv(reader.result);
        reader.readAsText(file);
    });
    zone.addEventListener('paste', e => {
        e.preventDefault();
        const text = e.clipboardData?.getData('text/plain') || '';
        if (text.trim()) processAndApplyCsv(text);
    });
})();

// ============================================================
// POPULATE FILTER DROPDOWNS
// ============================================================
(function populateFilters() {
    const positions = ['ALL', ...new Set(ALL_PROSPECTS.map(p => p.pos))];
    const teams     = ['ALL', ...new Set(ALL_PROSPECTS.map(p => p.team))].sort();

    const posEl  = document.getElementById('posFilter');
    const teamEl = document.getElementById('teamFilter');

    positions.forEach(v => {
        const o       = document.createElement('option');
        o.value       = v;
        o.textContent = v === 'ALL' ? 'All Positions' : v;
        posEl.appendChild(o);
    });
    teams.forEach(v => {
        const o       = document.createElement('option');
        o.value       = v;
        o.textContent = v === 'ALL' ? 'All Teams' : v;
        teamEl.appendChild(o);
    });
})();

// ============================================================
// RENDER TABLE
// ============================================================
function rankClass(r) {
    if (r <= 3)  return 'rank-gold';
    if (r <= 6)  return 'rank-silver';
    if (r <= 10) return 'rank-bronze';
    return 'rank-steel';
}

function volClass(v) {
    if (v === 'Low')      return 'vol-low';
    if (v === 'Moderate') return 'vol-mod';
    if (v === 'High')     return 'vol-high';
    if (v === 'Extreme')  return 'vol-extreme';
    return 'vol-na';
}

function render() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const pos    = document.getElementById('posFilter').value;
    const team   = document.getElementById('teamFilter').value;
    const vol    = document.getElementById('volFilter').value;

    const filtered = ALL_PROSPECTS.filter(p => {
        if (search && !p.name.toLowerCase().includes(search)) return false;
        if (pos  !== 'ALL' && p.pos  !== pos)  return false;
        if (team !== 'ALL' && p.team !== team) return false;
        if (vol  !== 'ALL' && p.volatility !== vol) return false;
        return true;
    });

    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';

    let lockInserted = false;

    filtered.forEach(p => {
        const isFree = p.displayRank <= FREE_LIMIT;

        // Insert lock wall once, right before the first locked prospect
        if (!isFree && !lockInserted) {
            lockInserted = true;
            const lockRow = document.createElement('tr');
            lockRow.className = 'lock-row';
            lockRow.innerHTML = `
                <td colspan="10">
                    <div class="lock-box">
                        <div class="lock-icon">🔒</div>
                        <div class="lock-title">Unlock Full Rankings</div>
                        <p class="lock-desc">See all 100+ prospects, full volatility analysis, historical tracking, and weekly updates.</p>
                        <button class="btn-unlock">Upgrade to Pro — $7 / mo</button>
                    </div>
                </td>
            `;
            tbody.appendChild(lockRow);
        }

        const tr = document.createElement('tr');
        if (!isFree) tr.className = 'locked-ghost';
        const owner = Object.keys(ownershipMap).length ? fuzzyMatchProspect(p.name, ownershipMap) : null;
        const isUnowned = Object.keys(ownershipMap).length && !owner;
        if (isUnowned) tr.classList.add('row-unowned');

        // 6 consensus dots (sources that agreed on position within ±10% percentile)
        const dotsHtml = [1,2,3,4,5,6].map(i =>
            `<div class="cons-dot ${i <= p.consensusAgreement ? 'on' : ''}"></div>`
        ).join('');

        // Single-source warning
        const warnHtml = p.sourceCount === 1
            ? `<span class="warn-badge">⚠ 1 source</span>`
            : '';

        const draftYear = getDraftYear(p.name);
        const draftCell = `<td class="draft-col">${draftYear ?? '—'}</td>`;
        tr.innerHTML = `
            <td><div class="rank-pill ${rankClass(p.displayRank)}">#${p.displayRank}</div></td>
            <td><div class="p-name">${p.name} ${warnHtml}</div></td>
            <td><span class="pos-badge">${p.pos}</span></td>
            <td class="team-col">${p.team}</td>
            <td class="num-col">${p.age}</td>
            <td class="num-col">${p.eta}</td>
            <td class="borda-col">${p.rankleScore.toFixed(1)}</td>
            <td>
                <span class="vol-badge ${volClass(p.volatility)}">${p.volatility}</span>
            </td>
            <td><div class="cons-dots">${dotsHtml}</div></td>
            ${draftCell}
        `;
        tbody.appendChild(tr);
    });

    // If every filtered result was free, still show the lock wall at the bottom
    // (only if paywall is active)
    if (!lockInserted && FREE_LIMIT < ALL_PROSPECTS.length) {
        const lockRow = document.createElement('tr');
        lockRow.className = 'lock-row';
        lockRow.innerHTML = `
            <td colspan="10">
                <div class="lock-box">
                    <div class="lock-icon">🔒</div>
                    <div class="lock-title">Unlock Full Rankings</div>
                    <p class="lock-desc">See all 100+ prospects, full volatility analysis, historical tracking, and weekly updates.</p>
                    <button class="btn-unlock">Upgrade to Pro — $7 / mo</button>
                </div>
            </td>
        `;
        tbody.appendChild(lockRow);
    }

}

// ── Wire up filters & initial render ──
document.getElementById('searchInput').addEventListener('input',  render);
document.getElementById('posFilter').addEventListener('change',  render);
document.getElementById('teamFilter').addEventListener('change', render);
document.getElementById('volFilter').addEventListener('change',  render);
render();

// Load MLB draft data in background; re-renders when done
loadDraftMap();
</script>
</body>
</html>
