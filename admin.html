<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rankle ‚Äì Admin Data Entry</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
    --bg-deep:    #0a0e1a;
    --bg-card:    #111827;
    --bg-input:   #1a2234;
    --border:     #1e2a40;
    --border-hi:  #2e3f5c;
    --text-hi:    #f1f5f9;
    --text-mid:   #94a3b8;
    --text-lo:    #4c5a72;
    --accent:     #3b82f6;
    --accent-hi:  #60a5fa;
    --green:      #34d399;
    --green-dim:  rgba(52,211,153,.12);
    --red:        #f87171;
    --red-dim:    rgba(248,113,113,.12);
    --gold:       #f59e0b;
    --gold-dim:   rgba(245,158,11,.12);
}
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family:'DM Sans',sans-serif;
    background:var(--bg-deep); color:var(--text-hi);
    min-height:100vh; -webkit-font-smoothing:antialiased;
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header {
    background:rgba(10,14,26,0.9); backdrop-filter:blur(12px);
    border-bottom:1px solid var(--border);
    padding:0 2rem; height:60px;
    display:flex; align-items:center; justify-content:space-between;
}
.logo { display:flex; align-items:center; gap:.6rem; }
.logo-icon {
    width:34px; height:34px;
    background:linear-gradient(135deg,#7c3aed,#6366f1);
    border-radius:8px; display:flex; align-items:center; justify-content:center;
    font-family:'Bebas Neue'; font-size:1.1rem; color:#fff;
}
.logo-title { font-family:'Bebas Neue'; font-size:1.4rem; letter-spacing:2px; }
.logo-badge {
    background:var(--gold-dim); color:var(--gold);
    font-size:.65rem; font-weight:700; letter-spacing:1px;
    padding:.15rem .45rem; border-radius:4px; text-transform:uppercase;
}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.wrap { max-width:1000px; margin:0 auto; padding:1.8rem 1.5rem; }

/* ‚îÄ‚îÄ SECTION TITLES ‚îÄ‚îÄ */
.section-title {
    font-family:'Bebas Neue'; font-size:1.2rem; letter-spacing:2px;
    color:#fff; margin-bottom:1rem; display:flex; align-items:center; gap:.5rem;
}
.section-title .ico { font-size:1.1rem; }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:12px; padding:1.5rem; margin-bottom:1.5rem;
}

/* ‚îÄ‚îÄ SOURCE SELECTOR ‚îÄ‚îÄ */
.source-row {
    display:flex; gap:.75rem; align-items:flex-end; flex-wrap:wrap; margin-bottom:1rem;
}
.field { display:flex; flex-direction:column; gap:.25rem; }
.field label { font-size:.68rem; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-lo); }
.field select, .field input {
    background:var(--bg-input); border:1px solid var(--border);
    border-radius:6px; padding:.45rem .6rem;
    color:var(--text-hi); font-size:.85rem; font-family:inherit;
    outline:none; transition:border-color .2s;
    min-width:140px;
}
.field select:focus, .field input:focus { border-color:var(--accent); }
.field input::placeholder { color:var(--text-lo); }
.field input[type="number"] { width:80px; min-width:80px; text-align:center; }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn {
    border:none; border-radius:6px; padding:.45rem 1rem;
    font-size:.82rem; font-weight:600; font-family:inherit;
    cursor:pointer; transition:transform .12s, box-shadow .15s;
    display:inline-flex; align-items:center; gap:.35rem;
}
.btn:hover { transform:translateY(-1px); }
.btn-primary   { background:linear-gradient(135deg,#2563eb,#1d4ed8); color:#fff; box-shadow:0 2px 10px rgba(37,99,235,.35); }
.btn-primary:hover { box-shadow:0 4px 16px rgba(37,99,235,.45); }
.btn-success   { background:linear-gradient(135deg,#059669,#047857); color:#fff; box-shadow:0 2px 10px rgba(5,150,105,.35); }
.btn-success:hover { box-shadow:0 4px 16px rgba(5,150,105,.45); }
.btn-ghost     { background:transparent; color:var(--text-mid); border:1px solid var(--border); }
.btn-ghost:hover { border-color:var(--border-hi); color:var(--text-hi); }
.btn-danger    { background:transparent; color:var(--red); border:1px solid rgba(248,113,113,.25); }
.btn-danger:hover { background:var(--red-dim); }
.btn-sm { padding:.28rem .6rem; font-size:.75rem; }

/* ‚îÄ‚îÄ PROSPECT LIST ‚îÄ‚îÄ */
.prospect-list { display:flex; flex-direction:column; gap:.5rem; }
.prospect-item {
    background:var(--bg-input); border:1px solid var(--border);
    border-radius:8px; padding:.7rem 1rem;
    display:flex; align-items:center; gap:1rem; flex-wrap:wrap;
    transition:border-color .2s;
}
.prospect-item:hover { border-color:var(--border-hi); }

.p-name-input {
    flex:1; min-width:160px;
    background:transparent; border:none; border-bottom:1px solid var(--border);
    color:var(--text-hi); font-size:.88rem; font-weight:600;
    padding:.2rem 0; outline:none; font-family:inherit;
    transition:border-color .2s;
}
.p-name-input:focus { border-color:var(--accent); }
.p-name-input::placeholder { color:var(--text-lo); font-weight:400; }

.p-meta { display:flex; gap:.5rem; }
.p-meta select {
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:5px; padding:.22rem .45rem;
    color:var(--text-mid); font-size:.78rem; font-family:inherit; outline:none;
}
.p-meta select:focus { border-color:var(--accent); }

.p-rank-input {
    width:50px; text-align:center;
    background:var(--bg-card); border:1px solid var(--border);
    border-radius:5px; padding:.22rem .3rem;
    color:var(--accent-hi); font-size:.85rem; font-weight:700;
    font-family:inherit; outline:none;
    transition:border-color .2s;
}
.p-rank-input:focus { border-color:var(--accent); }
.p-rank-input::placeholder { color:var(--text-lo); font-weight:400; }

.rank-label { font-size:.65rem; color:var(--text-lo); text-transform:uppercase; letter-spacing:.8px; text-align:center; margin-bottom:.1rem; }

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state {
    text-align:center; padding:2.5rem 1rem;
    color:var(--text-lo); font-size:.85rem;
}
.empty-state .ico { font-size:2rem; display:block; margin-bottom:.4rem; }

/* ‚îÄ‚îÄ PASTE ZONE ‚îÄ‚îÄ */
.paste-zone {
    border:2px dashed var(--border); border-radius:10px;
    padding:1.2rem; margin-bottom:1rem;
    transition:border-color .2s, background .2s;
}
.paste-zone:focus-within { border-color:var(--accent); background:rgba(59,130,246,.04); }
.paste-zone textarea {
    width:100%; background:transparent; border:none; outline:none; resize:none;
    color:var(--text-mid); font-size:.82rem; font-family:'DM Sans',monospace;
    line-height:1.7; min-height:100px;
}
.paste-zone textarea::placeholder { color:var(--text-lo); }
.paste-hint { font-size:.7rem; color:var(--text-lo); margin-top:.4rem; }

/* ‚îÄ‚îÄ OUTPUT BOX ‚îÄ‚îÄ */
.output-wrap { position:relative; }
.output-box {
    background:#0d1117; border:1px solid var(--border);
    border-radius:8px; padding:1rem 1.2rem;
    font-family:'SF Mono','Consolas',monospace;
    font-size:.75rem; color:#7dd3fc; line-height:1.7;
    white-space:pre; overflow-x:auto; max-height:320px; overflow-y:auto;
}
.copy-btn {
    position:absolute; top:.6rem; right:.6rem;
    background:rgba(17,24,39,.85); border:1px solid var(--border);
    color:var(--text-mid); border-radius:5px;
    padding:.25rem .55rem; font-size:.72rem; font-weight:600;
    cursor:pointer; font-family:inherit; transition:background .15s;
}
.copy-btn:hover { background:rgba(30,42,64,.9); color:var(--text-hi); }
.copy-btn.copied { color:var(--green); border-color:rgba(52,211,153,.3); }

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs { display:flex; gap:.25rem; margin-bottom:1.2rem; }
.tab {
    background:transparent; border:1px solid var(--border);
    border-radius:6px; padding:.4rem .85rem;
    color:var(--text-lo); font-size:.8rem; font-weight:600;
    cursor:pointer; font-family:inherit; transition:all .15s;
}
.tab:hover { border-color:var(--border-hi); color:var(--text-mid); }
.tab.active { background:var(--accent); border-color:var(--accent); color:#fff; }

/* ‚îÄ‚îÄ TAB PANELS ‚îÄ‚îÄ */
.tab-panel { display:none; }
.tab-panel.active { display:block; }

/* ‚îÄ‚îÄ STATUS ‚îÄ‚îÄ */
.status-bar {
    display:flex; gap:1.2rem; flex-wrap:wrap;
    padding:.8rem 0; border-bottom:1px solid var(--border); margin-bottom:1rem;
}
.status-item { display:flex; align-items:center; gap:.35rem; font-size:.78rem; }
.status-dot { width:7px; height:7px; border-radius:50%; }
.status-dot.green { background:var(--green); box-shadow:0 0 5px rgba(52,211,153,.4); }
.status-dot.gold  { background:var(--gold);  box-shadow:0 0 5px rgba(245,158,11,.4); }
.status-dot.grey  { background:var(--text-lo); }
.status-label { color:var(--text-mid); }

/* ‚îÄ‚îÄ DIVIDER ‚îÄ‚îÄ */
.divider { border:none; border-top:1px solid var(--border); margin:1.2rem 0; }

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:600px){
    .wrap { padding:1.2rem 1rem; }
    .prospect-item { gap:.5rem; }
    .p-name-input { min-width:120px; }
}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast {
    position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(120px);
    background:#1e293b; border:1px solid var(--green); border-radius:10px;
    padding:.85rem 1.6rem; display:flex; align-items:center; gap:.7rem;
    color:var(--text-hi); font-size:.85rem; font-weight:600;
    box-shadow:0 8px 32px rgba(0,0,0,.4);
    transition:transform .3s cubic-bezier(.34,1.56,.64,1), opacity .2s;
    z-index:999; pointer-events:none; opacity:0;
}
.toast.show { transform:translateX(-50%) translateY(0); opacity:1; }
.toast .toast-icon { font-size:1.3rem; }
</style>
</head>
<body>

<!-- HEADER -->
<header>
    <div class="logo">
        <div class="logo-icon">PR</div>
        <span class="logo-title">Rankle</span>
        <span class="logo-badge">Admin</span>
    </div>
    <div style="display:flex; align-items:center; gap:.75rem;">
        <span id="linkStatus" style="font-size:.75rem; color:var(--text-lo); display:none;">‚úì linked to index.html</span>
        <button id="linkBtn" class="btn btn-ghost btn-sm" onclick="linkIndexHTML()">üîó Link index.html</button>
    </div>
</header>

<div class="wrap">

    <!-- TABS -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('enter')">üìù Enter Rankings</button>
        <button class="tab" onclick="switchTab('paste')">üìã Paste Rankings</button>
        <button class="tab" onclick="switchTab('export')">üíæ Export Code</button>
        <button class="tab" onclick="switchTab('status')">üìÖ Last Updated</button>
        <button class="tab" onclick="switchTab('news')">üì∞ News Buzz</button>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: ENTER RANKINGS                                      -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-panel active" id="panel-enter">

        <div class="card">
            <div class="section-title"><span class="ico">üéØ</span> Source & List Length</div>
            <div class="source-row">
                <div class="field">
                    <label>Source</label>
                    <select id="sourceSelect" onchange="document.getElementById('listLengthInput').value=SOURCES[this.value].listLength; renderProspects();">
                        <option value="pipeline">MLB Pipeline</option>
                        <option value="ba">Baseball America</option>
                        <option value="fangraphs">FanGraphs</option>
                        <option value="br">Bleacher Report</option>
                        <option value="espn">ESPN</option>
                        <option value="justbaseball">Just Baseball</option>
                        <option value="rotoprospects">RotoProspects</option>
                        <option value="prospect361">Prospect361</option>
                        <option value="rotochamp">RotoChamp</option>
                    </select>
                </div>
                <div class="field">
                    <label>List Length</label>
                    <input type="number" id="listLengthInput" value="100" min="10" max="1000" onchange="updateListLength()">
                </div>
            </div>

            <!-- Status bar: how many prospects have a rank for this source -->
            <div class="status-bar" id="statusBar"></div>

            <!-- Prospect rows -->
            <div class="prospect-list" id="prospectList"></div>

            <!-- Add new prospect -->
            <div style="margin-top:1rem; padding-top:1rem; border-top:1px solid var(--border);">
                <button class="btn btn-ghost btn-sm" onclick="addProspect()">+ Add Prospect</button>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: PASTE RANKINGS                                      -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-panel" id="panel-paste">
        <div class="card">
            <div class="section-title"><span class="ico">üìã</span> Paste a Ranking List</div>
            <p style="color:var(--text-mid); font-size:.82rem; margin-bottom:1rem; line-height:1.6;">
                Copy the full text from a source's ranking page and paste it below. The parser will automatically extract names, ranks, teams, and positions ‚Äî and ignore everything else.
            </p>

            <div class="source-row" style="margin-bottom:.75rem;">
                <div class="field">
                    <label>Source</label>
                    <select id="pasteSourceSelect" onchange="document.getElementById('pasteListLength').value=SOURCES[this.value].listLength; saveToStorage();">
                        <option value="pipeline">MLB Pipeline</option>
                        <option value="ba">Baseball America</option>
                        <option value="fangraphs">FanGraphs</option>
                        <option value="br">Bleacher Report</option>
                        <option value="espn">ESPN</option>
                        <option value="justbaseball">Just Baseball</option>
                        <option value="rotoprospects">RotoProspects</option>
                        <option value="prospect361">Prospect361</option>
                        <option value="rotochamp">RotoChamp</option>
                    </select>
                </div>
                <div class="field">
                    <label>List Length</label>
                    <input type="number" id="pasteListLength" value="100" min="10" max="1000">
                </div>
            </div>

            <div class="paste-zone">
                <textarea id="pasteInput" placeholder="Paste the full text from the ranking page here‚Ä¶"></textarea>
            </div>
            <div class="paste-hint">Junk lines (ads, headers, image captions) are filtered out automatically. Names are fuzzy-matched.</div>

            <div style="margin-top:1rem; display:flex; gap:.6rem; align-items:center; flex-wrap:wrap;">
                <button class="btn btn-primary btn-sm" id="importBtn" onclick="importPasted()">Import & Save</button>
                <button class="btn btn-ghost btn-sm" onclick="previewParse()">üëÅ Preview</button>
                <span id="pasteResult" style="font-size:.78rem; color:var(--text-lo);"></span>
            </div>

            <!-- Preview table -->
            <div id="previewWrap" style="display:none; margin-top:1rem;">
                <div style="font-size:.7rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-lo); margin-bottom:.4rem;">Parsed Preview ‚Äî first 15 entries</div>
                <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:7px; overflow:hidden;">
                    <table style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr style="border-bottom:1px solid var(--border);">
                                <th style="text-align:left; padding:.45rem .6rem; font-size:.65rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-lo); font-weight:600;">#</th>
                                <th style="text-align:left; padding:.45rem .6rem; font-size:.65rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-lo); font-weight:600;">Name</th>
                                <th style="text-align:left; padding:.45rem .6rem; font-size:.65rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-lo); font-weight:600;">Team</th>
                                <th style="text-align:left; padding:.45rem .6rem; font-size:.65rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-lo); font-weight:600;">Pos</th>
                                <th style="text-align:left; padding:.45rem .6rem; font-size:.65rem; text-transform:uppercase; letter-spacing:1px; color:var(--text-lo); font-weight:600;">Match</th>
                            </tr>
                        </thead>
                        <tbody id="previewBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Bulk update ages & ETA -->
        <div class="card" style="margin-top:1rem;">
            <div class="section-title"><span class="ico">üéÇ</span> Bulk Update Ages &amp; ETA</div>
            <p style="color:var(--text-mid); font-size:.82rem; margin-bottom:.75rem; line-height:1.5;">Paste one per line: <strong>Name	Age</strong> or <strong>Name	Age	ETA</strong>. Use tab or comma between columns. ETA = year (e.g. 2026). Copy from RotoProspects, Baseball-Reference, etc.</p>
            <p style="color:var(--text-lo); font-size:.75rem; margin-bottom:.5rem;">When sources disagree on ETA, we use the <strong>earliest</strong> (most optimistic) year.</p>
            <div class="paste-zone" style="min-height:80px;">
                <textarea id="agePasteInput" placeholder="Konnor Griffin	20	2027&#10;Kevin McGonigle	20	2026&#10;Walker Jenkins	20	2027"></textarea>
            </div>
            <div style="margin-top:.75rem; display:flex; gap:.6rem; align-items:center; flex-wrap:wrap;">
                <button class="btn btn-primary btn-sm" onclick="bulkUpdateAges()">Update Ages</button>
                <button class="btn btn-ghost btn-sm" id="fetchAgesBtn" onclick="fetchAgesFromMLB()">‚ö° Fetch from MLB API</button>
                <button class="btn btn-ghost btn-sm" id="fetchRemainingBtn" onclick="fetchRemainingAges()">‚ö° Fetch remaining only</button>
                <button class="btn btn-ghost btn-sm" id="assignIdsBtn" onclick="assignIds()">üÜî Assign IDs</button>
                <span id="ageResult" style="font-size:.78rem; color:var(--text-lo);"></span>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: EXPORT                                              -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-panel" id="panel-export">
        <div class="card">
            <div class="section-title"><span class="ico">üíæ</span> Export Code</div>
            <p style="color:var(--text-mid); font-size:.82rem; margin-bottom:1rem; line-height:1.6;">
                Hit <strong style="color:#fff;">Save to index.html</strong> to write directly into your file ‚Äî no copy/paste needed. Keep admin.html and index.html in the same folder.
            </p>

            <div style="display:flex; gap:.6rem; margin-bottom:1rem; flex-wrap:wrap;">
                <button class="btn btn-success btn-sm" onclick="saveToIndexHTML()">üíæ Save to index.html</button>
                <button class="btn btn-ghost btn-sm" onclick="copyExport()">üìã Copy to Clipboard</button>
                <button class="btn btn-ghost btn-sm" onclick="downloadExport()">‚¨á Download as .js</button>
            </div>
            <span id="saveResult" style="font-size:.78rem; color:var(--text-lo); display:block; margin-bottom:.5rem;"></span>

            <div class="output-wrap">
                <div class="output-box" id="exportBox"></div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: NEWS BUZZ (GNews scraper)                           -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-panel" id="panel-news">
        <div class="card">
            <div class="section-title"><span class="ico">üì∞</span> News Scraper (GNews)</div>
            <p style="color:var(--text-mid); font-size:.82rem; margin-bottom:1rem; line-height:1.6;">
                Fetches news articles for each prospect and calculates a Buzz Score from sentiment and recency. Uses prospects from index.html when linked, otherwise from your current list. <strong>Requires a GNews API key</strong> ‚Äî get one free at <a href="https://gnews.io/register" target="_blank" rel="noopener" style="color:var(--accent-hi);">gnews.io/register</a>.
            </p>
            <div style="display:flex; gap:.6rem; align-items:flex-end; flex-wrap:wrap; margin-bottom:1rem;">
                <div class="field" style="min-width:200px;">
                    <label>GNews API Key</label>
                    <input type="password" id="gnewsApiKey" placeholder="Enter your GNews API key" style="width:100%;">
                </div>
                <div class="field" style="min-width:80px;">
                    <label>Limit</label>
                    <input type="number" id="newsLimitInput" placeholder="All" min="1" max="500" style="width:80px; text-align:center;">
                </div>
                <button class="btn btn-primary" id="scrapeNewsBtn" onclick="scrapeNewsForAllProspects()">üì∞ Scrape News</button>
                <button class="btn btn-ghost" id="scrapeNewsCancelBtn" onclick="cancelNewsScrape()" style="display:none; color:var(--red);">Cancel</button>
            </div>
            <div id="newsResult" style="font-size:.82rem; color:var(--text-mid); margin-bottom:1rem;"></div>
            <div id="newsResultsTable" style="overflow-x:auto; max-height:400px; overflow-y:auto;"></div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- TAB: LAST UPDATED                                       -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="tab-panel" id="panel-status">
        <div class="card">
            <div class="section-title"><span class="ico">üìÖ</span> Source Update Timestamps</div>
            <p style="color:var(--text-mid); font-size:.82rem; margin-bottom:1rem; line-height:1.6;">
                When you import a list from the Paste tab, the timestamp for that source is updated. Use this to track which lists need refreshing.
            </p>
            <div style="display:grid; gap:.5rem;" id="statusList"></div>
        </div>
    </div>

</div><!-- /wrap -->

<script>
// ============================================================
// STATE ‚Äî mirrors the structure in index.html exactly
// ============================================================
const SOURCES = {
    pipeline:     { label:"MLB Pipeline",     listLength:100 },
    ba:           { label:"Baseball America", listLength:100 },
    fangraphs:    { label:"FanGraphs",        listLength:100 },
    br:           { label:"Bleacher Report",  listLength:100 },
    espn:         { label:"ESPN",             listLength:100 },
    justbaseball: { label:"Just Baseball",    listLength:100 },
    rotoprospects:{ label:"RotoProspects",    listLength:100 },
    prospect361:  { label:"Prospect361",      listLength:100 },
    rotochamp:    { label:"RotoChamp",        listLength:100 }
};

// Holds a reference to index.html. Persisted in IndexedDB across sessions.
let indexFileHandle = null;
const IDB_NAME = 'rankle-admin';
const IDB_STORE = 'file-handle';

async function persistFileHandle(handle) {
    try {
        const db = await new Promise((res,rej)=>{ const r = indexedDB.open(IDB_NAME,1); r.onerror=rej; r.onsuccess=()=>res(r.result); r.onupgradeneeded=e=>{ e.target.result.createObjectStore(IDB_STORE); }; });
        await new Promise((res,rej)=>{ const t=db.transaction(IDB_STORE,'readwrite'); t.objectStore(IDB_STORE).put(handle,'index'); t.oncomplete=res; t.onerror=rej; });
    } catch(e) { /* ignore */ }
}
async function restoreFileHandle() {
    try {
        const db = await new Promise((res,rej)=>{ const r = indexedDB.open(IDB_NAME); r.onerror=rej; r.onsuccess=()=>res(r.result); });
        const handle = await new Promise((res,rej)=>{ const t=db.transaction(IDB_STORE,'readonly'); const r=t.objectStore(IDB_STORE).get('index'); r.onsuccess=()=>res(r.result); r.onerror=rej; });
        if (handle) {
            const file = await handle.getFile(); // verify still valid and read contents
            const content = await file.text();
            indexFileHandle = handle;
            document.getElementById('linkStatus').style.display = 'inline';
            document.getElementById('linkBtn').style.display = 'none';
            document.getElementById('linkStatus').textContent = '‚úì linked to index.html';
            // Hydrate lastUpdated from any LAST_UPDATED block in index.html
            updateLastUpdatedFromIndexContent(content);
        }
    } catch(e) { /* handle invalidated */ }
}
async function clearPersistedHandle() {
    try {
        const db = await new Promise((res,rej)=>{ const r = indexedDB.open(IDB_NAME); r.onerror=rej; r.onsuccess=()=>res(r.result); });
        await new Promise((res,rej)=>{ const t=db.transaction(IDB_STORE,'readwrite'); t.objectStore(IDB_STORE).delete('index'); t.oncomplete=res; t.onerror=rej; });
    } catch(e) { /* ignore */ }
}

// ============================================================
// LINK index.html ‚Äî grab a file handle, persist across sessions
// ============================================================
async function linkIndexHTML() {
    if (!window.showOpenFilePicker) {
        alert("This feature requires Chrome or Edge.");
        return;
    }
    try {
        const [handle] = await window.showOpenFilePicker({
            types: [{ description:'HTML Files', accept:{'text/html':['.html']} }],
            suggestedName: 'index.html'
        });
        const file = await handle.getFile();
        const content = await file.text();
        if (!content.includes('const SOURCES =') || !content.includes('const RAW_DATA =')) {
            alert("That doesn't look like a Rankle index.html ‚Äî no SOURCES or RAW_DATA found.");
            return;
        }
        indexFileHandle = handle;
        await persistFileHandle(handle);
        // Pull in any persisted LAST_UPDATED timestamps from index.html
        updateLastUpdatedFromIndexContent(content);
        document.getElementById('linkStatus').style.display = 'inline';
        document.getElementById('linkStatus').textContent = '‚úì linked to index.html';
        document.getElementById('linkBtn').style.display = 'none';
    } catch (e) {
        if (e.name !== 'AbortError') alert("Error: " + e.message);
    }
}

// ============================================================
// WRITE TO index.html ‚Äî surgical replace using the linked handle
// ============================================================
async function writeToIndex() {
    if (!indexFileHandle) return false;
    try {
        const file = await indexFileHandle.getFile();
        const content = await file.text();
        const newData = generateExportCode();
        const startIdx = content.indexOf('const SOURCES =');
        const afterStart = content.slice(startIdx);
        // Replace SOURCES + RAW_DATA, and optionally an existing LAST_UPDATED block
        const endMatch = afterStart.match(/const RAW_DATA = \[[\s\S]*?\];(?:\s*const LAST_UPDATED = \{[\s\S]*?\};)?/);
        if (startIdx === -1 || !endMatch) return false;
        const endIdx = startIdx + endMatch.index + endMatch[0].length;
        const newContent = content.slice(0, startIdx) + newData + content.slice(endIdx);
        if (typeof indexFileHandle.queryPermission === 'function' && (await indexFileHandle.queryPermission({ mode: 'readwrite' })) !== 'granted') {
            if (typeof indexFileHandle.requestPermission === 'function' && (await indexFileHandle.requestPermission({ mode: 'readwrite' })) !== 'granted') return false;
        }
        const writable = await indexFileHandle.createWritable();
        await writable.write(newContent);
        await writable.close();
        return true;
    } catch (e) {
        indexFileHandle = null;
        await clearPersistedHandle();
        document.getElementById('linkStatus').style.display = 'none';
        document.getElementById('linkBtn').style.display = 'inline-block';
        return false;
    }
}

// Each prospect: { name, pos, team, age, eta, ranks: { source: rank|null } }
// These are fallback defaults only ‚Äî all ranks null until you import a source.
// localStorage will override this with your real data after first import.
let prospects = [];

const POSITIONS = ["SS","OF","RHP","LHP","1B","2B","3B","C","SP","RP"];
const TEAMS = ["ATH","ATL","ARI","BAL","BOS","CHC","CWS","CIN","CLE","COL","DET","HOU","KC","LAD","LAA","MIA","MIL","MIN","NYM","NYY","OAK","PHI","PIT","SD","SEA","SF","STL","TB","TEX","TOR","WAS"];

// ============================================================
// TAB SWITCHING
// ============================================================
const TAB_ORDER = ['enter','paste','export','status','news'];
function switchTab(name) {
    document.querySelectorAll('.tab').forEach((t,i) => t.classList.toggle('active', TAB_ORDER[i] === name));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('panel-'+name).classList.add('active');
    if (name === 'export') renderExport();
    if (name === 'status') renderStatus();
    if (name === 'news' && document.getElementById('gnewsApiKey') && !document.getElementById('gnewsApiKey').value) {
        const k = sessionStorage.getItem('rankle-gnews-key');
        if (k) document.getElementById('gnewsApiKey').value = k;
    }
}

// ============================================================
// ENTER TAB ‚Äî RENDER PROSPECT LIST
// ============================================================
function renderProspects() {
    const source = document.getElementById('sourceSelect').value;
    const list   = document.getElementById('prospectList');
    list.innerHTML = '';

    // Status bar
    const ranked   = prospects.filter(p => p.ranks[source] !== null).length;
    const total    = prospects.length;
    document.getElementById('statusBar').innerHTML = `
        <div class="status-item"><div class="status-dot green"></div><span class="status-label">${ranked} ranked</span></div>
        <div class="status-item"><div class="status-dot gold"></div><span class="status-label">${total - ranked} unranked</span></div>
        <div class="status-item"><div class="status-dot grey"></div><span class="status-label">${total} total prospects</span></div>
        <div class="status-item" style="margin-left:auto;"><span class="status-label" style="color:var(--text-lo); font-size:.72rem;">List length: ${SOURCES[source].listLength}</span></div>
    `;

    // Sort: ranked first (by rank asc), then unranked
    const sorted = [...prospects].sort((a,b) => {
        const ar = a.ranks[source], br2 = b.ranks[source];
        if (ar !== null && br2 !== null) return ar - br2;
        if (ar !== null) return -1;
        if (br2 !== null) return 1;
        return a.name.localeCompare(b.name);
    });

    sorted.forEach((p, i) => {
        const idx = prospects.indexOf(p);
        const rank = p.ranks[source];

        // Position options
        const posOpts = POSITIONS.map(v => `<option value="${v}" ${p.pos===v?'selected':''}>${v}</option>`).join('');
        // Team options
        const teamOpts = TEAMS.map(v => `<option value="${v}" ${p.team===v?'selected':''}>${v}</option>`).join('');

        list.innerHTML += `
            <div class="prospect-item" data-idx="${idx}">
                <input class="p-name-input" value="${p.name}" placeholder="Player name‚Ä¶"
                    onchange="updateName(${idx}, this.value)">
                <div class="p-meta">
                    <select onchange="updateMeta(${idx},'pos',this.value)">${posOpts}</select>
                    <select onchange="updateMeta(${idx},'team',this.value)">${teamOpts}</select>
                    <input type="number" placeholder="Age" value="${p.age}" style="width:50px; min-width:50px;"
                        onchange="updateMeta(${idx},'age',parseInt(this.value))">
                    <input type="text" placeholder="ETA" value="${p.eta}" style="width:50px; min-width:50px;"
                        onchange="updateMeta(${idx},'eta',this.value)">
                </div>
                <div style="display:flex; flex-direction:column; align-items:center;">
                    <div class="rank-label">${SOURCES[source].label.split(' ')[0]}</div>
                    <input type="number" class="p-rank-input" placeholder="#"
                        value="${rank !== null ? rank : ''}"
                        onchange="updateRank(${idx}, '${source}', this.value)">
                </div>
                <button class="btn btn-danger btn-sm" onclick="removeProspect(${idx})">‚úï</button>
            </div>
        `;
    });
}

function updateListLength() {
    const source = document.getElementById('sourceSelect').value;
    SOURCES[source].listLength = parseInt(document.getElementById('listLengthInput').value) || 100;
    renderProspects();
}

function updateName(idx, val) {
    prospects[idx].name = val.trim();
    saveToStorage();
}
function updateMeta(idx, key, val) {
    prospects[idx][key] = val;
    saveToStorage();
}
function updateRank(idx, source, val) {
    prospects[idx].ranks[source] = val === '' ? null : parseInt(val);
    renderExport();
    saveToStorage();
}
function addProspect() {
    const blank = { name:"", pos:"SS", team:"ATH", age:18, eta:"2027", ranks:{} };
    Object.keys(SOURCES).forEach(s => blank.ranks[s] = null);
    prospects.push(blank);
    saveToStorage();
    renderProspects();
    // focus the new name input
    setTimeout(() => {
        const inputs = document.querySelectorAll('.p-name-input');
        if (inputs.length) inputs[inputs.length-1].focus();
    }, 50);
}
function removeProspect(idx) {
    if (confirm(`Remove ${prospects[idx].name || 'this prospect'}?`)) {
        prospects.splice(idx, 1);
        saveToStorage();
        renderProspects();
        renderExport();
    }
}

// ============================================================
// TEAM NAME ‚Üí ABBREVIATION MAP
// ============================================================
const TEAM_MAP = {
    "arizona diamondbacks":"ARI","atlanta braves":"ATL","baltimore orioles":"BAL",
    "boston red sox":"BOS","chicago cubs":"CHC","chicago white sox":"CWS",
    "cincinnati reds":"CIN","cleveland guardians":"CLE","colorado rockies":"COL",
    "detroit tigers":"DET","houston astros":"HOU","kansas city royals":"KC",
    "los angeles angels":"LAA","los angeles dodgers":"LAD","miami marlins":"MIA",
    "milwaukee brewers":"MIL","minnesota twins":"MIN","new york mets":"NYM",
    "new york yankees":"NYY","oakland athletics":"OAK","athletics":"ATH",
    "philadelphia phillies":"PHI","pittsburgh pirates":"PIT","san diego padres":"SD",
    "seattle mariners":"SEA","san francisco giants":"SF","st. louis cardinals":"STL",
    "tampa bay rays":"TB","texas rangers":"TEX","toronto blue jays":"TOR",
    "washington nationals":"WAS"
};
// RotoProspects uses "SL" for St. Louis ‚Äî normalize to STL
const ROTOPROSPECTS_TEAM_ALIAS = { "SL":"STL" };
const ROTOCHAMP_TEAM_ALIAS = { "KAN":"KC", "CWS":"CHW", "OAK":"ATH" };

// ============================================================
// SOURCE ‚Üí PARSER MAP
// Add new sources here. Each source maps to its parser function.
// If a source doesn't have a dedicated parser yet, it falls back
// to "numbered" (1. Name) automatically.
// ============================================================
const SOURCE_PARSER = {
    pipeline:     'pipeline',    // MLB Pipeline: 5-line block with junk stats line
    ba:           'ba',          // Baseball America: 4-line block
    fangraphs:    'numbered',   // placeholder
    br:           'numbered',   // placeholder
    espn:         'numbered',   // placeholder
    justbaseball: 'numbered',   // placeholder
    rotoprospects:'rotoprospects',  // Tab-separated: Rank	Name	Pos	Team	B/T	Grades	Level	Age	ETA	Last
    prospect361:  'prospect361',   // "1. Name (Pos, Team) ‚Äì description"
    rotochamp:   'rotochamp'      // Tab: Rank	Name	Team	Pos	Age	ETA	999	999	?	999
};

// ============================================================
// PARSERS ‚Äî one per format
// ============================================================

// Baseball America: 4-line repeating block
//   1. Name
//   Team Name
//   Position
//   Headshot of ‚Ä¶  (junk)
function parseBA(rawText) {
    const lines = rawText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
    const out   = [];
    for (let i = 0; i < lines.length; i++) {
        const m = lines[i].match(/^(\d+)\.\s+(.+)$/);
        if (!m) continue;
        const rank = parseInt(m[1]);
        const name = m[2].trim();
        const teamRaw = (lines[i+1] || '').trim().toLowerCase();
        const team    = TEAM_MAP[teamRaw] || null;
        const posRaw  = (lines[i+2] || '').trim();
        const pos     = /^[A-Z\/\s\d]+$/.test(posRaw) ? posRaw.split(/\s*[\/\|]\s*/)[0].trim() : null;
        out.push({ rank, name, team, pos });
    }
    return out;
}

// MLB Pipeline: repeating blocks anchored on bare rank numbers.
// Between each rank we expect: "Photo headshot‚Ä¶", Name, Position, "‚Ä¶ Logo", Team, Level, Stats.
// Parser anchors on rank lines and grabs name/pos/team by skipping known junk patterns.
function parsePipeline(rawText) {
    // Split on both newlines AND tabs to handle browser textarea quirks
    const lines = rawText.split(/[\n\r]+/).map(l => l.trim()).filter(l => l.length > 0);
    const out   = [];
    const POS_MAP = { "INF":"SS", "DH":"1B" };

    // First pass: find all rank-line indices (bare number followed by "Photo headshot‚Ä¶")
    const rankIndices = [];
    for (let i = 0; i < lines.length - 1; i++) {
        if (/^\d+$/.test(lines[i]) && lines[i+1].startsWith('Photo headshot')) {
            rankIndices.push(i);
        }
    }

    for (let r = 0; r < rankIndices.length; r++) {
        const rank      = parseInt(lines[rankIndices[r]]);
        const start     = rankIndices[r] + 1;
        const end       = r + 1 < rankIndices.length ? rankIndices[r + 1] : lines.length;
        const block     = lines.slice(start, end);

        // Filter out junk lines: "Photo headshot‚Ä¶", "‚Ä¶ Logo", level codes, stats
        const clean = block.filter(l => {
            if (l.startsWith('Photo headshot')) return false;
            if (l.endsWith('Logo'))             return false;
            if (/^(MLB|AAA|AA|A\+|A|ROK)$/.test(l)) return false;
            if (/^\d{4}/.test(l))               return false; // stats line starts with year
            if (/^\d+$/.test(l))                return false; // bare numbers (age, etc from tab-split)
            if (/^[LRS]$/.test(l))              return false; // throws/bats single letters
            if (/^\d+'\s*\d*"?/.test(l))        return false; // height like 6' 4"
            if (/^\d+\s*lbs/.test(l))           return false; // weight like 225 lbs
            if (/^\d+"\s*\//.test(l))           return false; // fragment like 4" / 225 lbs
            return true;
        });

        // clean[0] = name, clean[1] = position, clean[2] = team
        if (clean.length < 3) continue;
        const name    = clean[0];
        const posRaw  = clean[1].split('/')[0].trim();
        const pos     = POS_MAP[posRaw] || posRaw;
        const team    = TEAM_MAP[clean[2].toLowerCase()] || null;

        out.push({ rank, name, pos, team });
    }
    return out;
}

// Prospect361: "1. Name (Pos, Team) ‚Äì description" ‚Äî one per line, em dash separates meta from blurb
function parseProspect361(rawText) {
    const lines = rawText.split(/[\n\r]+/).map(l => l.trim()).filter(l => l.length > 0);
    const out = [];
    // Prospect361 team abbreviations -> our codes (most map 1:1 when uppercased)
    const TEAM_ABBREV = { "pit":"PIT","mil":"MIL","det":"DET","stl":"STL","min":"MIN","bal":"BAL","tex":"TEX","phi":"PHI","bos":"BOS","lad":"LAD","sea":"SEA","nym":"NYM","tor":"TOR","cin":"CIN","chc":"CHC","mia":"MIA","hou":"HOU","ath":"ATH","ari":"ARI","tb":"TB","chw":"CHW","cle":"CLE","col":"COL","was":"WAS","atl":"ATL","sd":"SD","kc":"KC","nyy":"NYY","sf":"SF" };
    const POS_ALIAS = { "BHP":"SPRP", "INF":"SS", "DH":"1B" };

    for (const line of lines) {
        // Match: "1. Name (Pos, Team) ‚Äì" or "1. Name (Pos, Team) -" (em dash or hyphen)
        const m = line.match(/^(\d+)\.\s+(.+?)\s+\(([^,]+),\s*([^)]+)\)\s+[‚Äì\-]/);
        if (!m) continue;
        const rank = parseInt(m[1], 10);
        const name = m[2].trim();
        let pos = (m[3] || '').trim();
        if (pos && pos.includes('/')) pos = pos.split('/')[0].trim();
        pos = POS_ALIAS[pos] || pos || null;
        const teamRaw = (m[4] || '').trim().toLowerCase();
        const team = TEAM_ABBREV[teamRaw] || teamRaw.toUpperCase() || null;
        out.push({ rank, name, pos, team });
    }
    return out;
}

// RotoChamp: Rank\tName\tTeam\tPos\tAge\tETA\t999\t999\t?\t999 ‚Äî tab-separated, age/ETA can be empty
function parseRotoChamp(rawText) {
    const lines = rawText.split(/[\n\r]+/).map(l => l.trim()).filter(l => l.length > 0);
    const out = [];
    const POS_ALIAS = { "DH":"1B", "INF":"SS" };
    const NAME_ALIAS = { "Leodalis De Vries":"Leo De Vries", "George Lombard Jr.":"George Lombard" };
    for (const line of lines) {
        const cols = line.split('\t');
        if (cols.length < 4) continue;
        const rankNum = parseInt(cols[0], 10);
        if (isNaN(rankNum) || rankNum < 1) continue;
        let name = cols[1].trim();
        if (NAME_ALIAS[name]) name = NAME_ALIAS[name];
        if (!name) continue;
        let team = (cols[2] || '').trim().toUpperCase();
        if (ROTOCHAMP_TEAM_ALIAS[team]) team = ROTOCHAMP_TEAM_ALIAS[team];
        let pos = (cols[3] || '').trim();
        if (pos && pos.includes('/')) pos = pos.split('/')[0].trim();
        pos = POS_ALIAS[pos] || pos || null;
        const ageRaw = (cols[4] || '').trim();
        const age = ageRaw && !/^999$/.test(ageRaw) ? parseInt(ageRaw, 10) : null;
        const etaRaw = (cols[5] || '').trim();
        const eta = etaRaw && /20\d{2}/.test(etaRaw) ? etaRaw.replace(/\D/g, '').slice(0, 4) : null;
        out.push({ rank: rankNum, name, pos, team: team || null, age: (age >= 16 && age <= 50) ? age : null, eta });
    }
    return out;
}

// RotoProspects: Rank, Name, Pos, Team, B/T, Grades, Level, Age, ETA, Last
function parseRotoProspects(rawText) {
    const lines = rawText.split(/[\n\r]+/).map(l => l.trim()).filter(l => l.length > 0);
    const out = [];
    for (const line of lines) {
        let cols = line.split('\t');
        if (cols.length < 8) cols = line.split(/\s{2,}/);
        if (cols.length < 4) continue;
        const rankNum = parseInt(cols[0], 10);
        if (isNaN(rankNum) || rankNum < 1) continue;
        const name = cols[1].trim();
        if (!name) continue;
        let pos = (cols[2] || '').trim();
        if (pos && pos.includes('/')) pos = pos.split('/')[0].trim();
        let team = (cols[3] || '').trim().toUpperCase();
        if (ROTOPROSPECTS_TEAM_ALIAS[team]) team = ROTOPROSPECTS_TEAM_ALIAS[team];
        const age = cols.length > 7 ? parseInt(cols[7], 10) : null;
        const etaRaw = cols.length > 8 ? (cols[8] || '').trim() : null;
        const eta = etaRaw && /20\d{2}/.test(etaRaw) ? etaRaw.replace(/\D/g, '').slice(0, 4) : null;
        out.push({ rank: rankNum, name, pos: pos || null, team: team || null, age, eta });
    }
    return out;
}

// Numbered list: "1. Name" or "1) Name", one per line
function parseNumbered(rawText) {
    return rawText.split('\n')
        .map(l => l.trim())
        .filter(l => l.length > 0)
        .map(l => {
            const m = l.match(/^(\d+)[\.\)]\s+(.+)$/);
            return m ? { rank: parseInt(m[1]), name: m[2].trim(), team: null, pos: null } : null;
        })
        .filter(Boolean);
}

// Names only: one name per line, rank = line order
function parseNamesOnly(rawText) {
    return rawText.split('\n')
        .map(l => l.trim())
        .filter(l => l.length > 0)
        .map((name, i) => ({ rank: i + 1, name, team: null, pos: null }));
}

function runParser() {
    const source = document.getElementById('pasteSourceSelect').value;
    const fmt    = SOURCE_PARSER[source] || 'numbered';
    const text   = document.getElementById('pasteInput').value;
    if (fmt === 'ba')            return parseBA(text);
    if (fmt === 'pipeline')      return parsePipeline(text);
    if (fmt === 'rotoprospects') return parseRotoProspects(text);
    if (fmt === 'prospect361')   return parseProspect361(text);
    if (fmt === 'rotochamp')     return parseRotoChamp(text);
    if (fmt === 'numbered')      return parseNumbered(text);
    return parseNamesOnly(text);
}

// ============================================================
// FUZZY MATCH ‚Äî name ‚Üí existing prospect index
// ============================================================
function fuzzyMatch(input, candidates) {
    const norm = s => s.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/\s+/g," ").trim();
    const ni = norm(input);
    if (!ni) return null;

    let best = null, bestScore = 0;
    candidates.forEach((c, i) => {
        const nc = norm(c.name);
        if (nc === ni)                          { best = i; bestScore = 999; return; }
        if (nc.includes(ni) || ni.includes(nc)) { if (bestScore < 90) { best = i; bestScore = 90; } return; }
        const parts = nc.split(' ');
        if (parts[parts.length-1] === ni.split(' ').pop() && bestScore < 70) { best = i; bestScore = 70; }
    });
    return bestScore >= 70 ? best : null;
}

// ============================================================
// PREVIEW ‚Äî show what will be imported before committing
// ============================================================
function previewParse() {
    const parsed = runParser();
    if (!parsed.length) {
        document.getElementById('pasteResult').innerHTML = '<span style="color:var(--red);">Nothing parsed ‚Äî check the format selector.</span>';
        return;
    }

    const tbody = document.getElementById('previewBody');
    tbody.innerHTML = '';
    const show = parsed.slice(0, 15);

    show.forEach(p => {
        const idx   = fuzzyMatch(p.name, prospects);
        const match = idx !== null ? prospects[idx].name : null;
        const color = match ? 'var(--green)' : 'var(--gold)';
        const label = match ? `‚úì ${match}` : '+ new';

        tbody.innerHTML += `
            <tr style="border-bottom:1px solid var(--border);">
                <td style="padding:.4rem .6rem; color:var(--text-lo); font-size:.8rem;">${p.rank}</td>
                <td style="padding:.4rem .6rem; font-size:.82rem; font-weight:600;">${p.name}</td>
                <td style="padding:.4rem .6rem; font-size:.8rem; color:var(--text-mid);">${p.team || '‚Äî'}</td>
                <td style="padding:.4rem .6rem; font-size:.8rem; color:var(--text-mid);">${p.pos || '‚Äî'}</td>
                <td style="padding:.4rem .6rem; font-size:.75rem; color:${color}; font-weight:600;">${label}</td>
            </tr>`;
    });

    document.getElementById('previewWrap').style.display = 'block';
    document.getElementById('pasteResult').innerHTML = `<span style="color:var(--text-mid);">Parsed ${parsed.length} prospects ‚Äî preview showing first 15</span>`;
}

// ============================================================
// FETCH AGES FROM MLB API ‚Äî automated lookup
// ============================================================
let _draftAgesCache = null;
async function getDraftAgesMap() {
    if (_draftAgesCache) return _draftAgesCache;
    const proxy = (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const map = {};
    for (const year of [2024, 2023]) {
        try {
            let r;
            try { r = await fetch(`https://statsapi.mlb.com/api/v1/draft/${year}`); } catch (e) { r = await fetch(proxy(`https://statsapi.mlb.com/api/v1/draft/${year}`)); }
            const data = await r.json();
            const picks = data.drafts?.rounds || [];
            picks.forEach(round => {
                (round.picks || []).forEach(pick => {
                    const person = pick.person;
                    if (person?.fullName && person?.id && person.currentAge >= 16 && person.currentAge <= 50) {
                        map[person.fullName] = { age: person.currentAge, id: person.id };
                    }
                });
            });
        } catch (e) {}
    }
    _draftAgesCache = map;
    return map;
}

async function fetchAgesFromMLB() { await doFetchAges(null); }
async function fetchRemainingAges() { await doFetchAges(19); }
async function assignIds() {
    const needId = prospects.map((p,i) => [i,p]).filter(([i,p]) => !p.mlbId);
    if (needId.length === 0) {
        document.getElementById('ageResult').innerHTML = '<span style="color:var(--green);">‚úì All prospects already have MLB IDs</span>';
        return;
    }
    await doFetchAges(null, needId);
}

async function doFetchAges(onlyIfAge, indicesToFetch) {
    const btn = document.getElementById('fetchAgesBtn');
    const remBtn = document.getElementById('fetchRemainingBtn');
    const assignBtn = document.getElementById('assignIdsBtn');
    const resultEl = document.getElementById('ageResult');
    btn.disabled = true;
    if (remBtn) remBtn.disabled = true;
    if (assignBtn) assignBtn.disabled = true;
    let toFetch;
    if (indicesToFetch && indicesToFetch.length > 0) {
        toFetch = indicesToFetch;
    } else if (onlyIfAge !== null) {
        toFetch = prospects.map((p,i) => [i,p]).filter(([i,p]) => p.age === onlyIfAge);
    } else {
        toFetch = prospects.map((p,i) => [i,p]);
    }
    resultEl.innerHTML = `<span style="color:var(--text-mid);">Fetching‚Ä¶ 0/${toFetch.length}</span>`;
    const proxy = (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const personUrl = (id) => `https://statsapi.mlb.com/api/v1/people/${id}`;
    const search = (name) => `https://statsapi.mlb.com/api/v1/people/search?names=${encodeURIComponent(name)}`;
    const tryNames = (name) => {
        const n = name.trim();
        const out = [n];
        if (n.endsWith(' Jr.')) out.push(n.replace(/ Jr\.?$/i, ''));
        if (n.endsWith(' Jr')) out.push(n.replace(/ Jr$/i, ''));
        if (n.includes(',')) out.push(n.split(',')[0].trim() + ' ' + (n.split(',')[1] || '').trim());
        const parts = n.split(/\s+/);
        if (parts.length >= 2) out.push(parts[parts.length-1] + ' ' + parts.slice(0,-1).join(' '));
        return [...new Set(out)];
    };
    let updated = 0, failed = 0, idsAssigned = 0;
    for (let j = 0; j < toFetch.length; j++) {
        const [i, p] = toFetch[j];
        resultEl.innerHTML = `<span style="color:var(--text-mid);">Fetching‚Ä¶ ${j + 1}/${toFetch.length}</span>`;
        let found = false;
        if (p.mlbId) {
            try {
                let r;
                try { r = await fetch(personUrl(p.mlbId)); } catch (e) { r = await fetch(proxy(personUrl(p.mlbId))); }
                const data = await r.json();
                const person = data.people?.[0];
                if (person && person.currentAge >= 16 && person.currentAge <= 50) {
                    prospects[i].age = person.currentAge;
                    updated++;
                    found = true;
                }
            } catch (e) {}
            await new Promise(r => setTimeout(r, 60));
        }
        if (!found) {
            for (const qName of tryNames(p.name)) {
                try {
                    let r;
                    try { r = await fetch(search(qName)); } catch (e) { r = await fetch(proxy(search(qName))); }
                    const data = await r.json();
                    const person = data.people?.[0];
                    if (person && person.currentAge >= 16 && person.currentAge <= 50) {
                        prospects[i].age = person.currentAge;
                        prospects[i].mlbId = person.id;
                        updated++;
                        idsAssigned++;
                        found = true;
                        break;
                    }
                } catch (e) {}
                await new Promise(r => setTimeout(r, 80));
            }
        }
        if (!found) {
            try {
                const draftMap = await getDraftAgesMap();
                const entry = draftMap[p.name] || draftMap[p.name.replace(/\s+Jr\.?$/i,'')];
                if (entry && entry.age) {
                    prospects[i].age = entry.age;
                    if (entry.id) { prospects[i].mlbId = entry.id; idsAssigned++; }
                    updated++;
                    found = true;
                }
            } catch (e) {}
        }
        if (!found) failed++;
        await new Promise(r => setTimeout(r, 120));
    }
    saveToStorage();
    renderProspects();
    renderExport();
    if (indexFileHandle) await writeToIndex().then(ok => { if (ok) saveToStorage(); });
    const stillMissing = prospects.filter(p => p.age === 19);
    const withId = prospects.filter(p => p.mlbId).length;
    let msg = `<span style="color:var(--green);">‚úì Updated ${updated} ages</span>`;
    if (idsAssigned) msg += ` ¬∑ <span style="color:var(--accent-hi);">${idsAssigned} IDs assigned</span>`;
    msg += ` <span style="color:var(--text-lo); font-size:.8rem;">(${withId} with mlbId)</span>`;
    if (failed) msg += ` <span style="color:var(--gold);">(${failed} not found)</span>`;
    if (stillMissing.length > 0) {
        msg += `<br><span style="color:var(--text-lo); font-size:.72rem;">${stillMissing.length} still at 19 ‚Äî names listed in box above. Add ages (tab or comma after each name) and click Update Ages.</span>`;
        document.getElementById('agePasteInput').value = stillMissing.map(p => p.name + '\t').join('\n');
    }
    resultEl.innerHTML = msg;
    btn.disabled = false;
    if (remBtn) remBtn.disabled = false;
    if (assignBtn) assignBtn.disabled = false;
}

// ============================================================
// NEWS SCRAPER (GNews only ‚Äî no Reddit)
// ============================================================
const POSITIVE_KEYWORDS = ["breakout","sleeper","stash","must-add","must add","call-up","callup","promoted","raking","mashing","filthy","ace","stud","league winner","add now","get him","fire","elite","dominant","nasty","underrated"];
const NEGATIVE_KEYWORDS = ["injured","injury","IL","surgery","torn","struggling","demoted","bust","avoid","drop","overrated","overhyped","disappointing","setback","shut down","out for","DL"];
const BASEBALL_KEYWORDS = ["prospect","mlb","minor league","baseball","draft","rookie","call-up","callup","triple-a","double-a","single-a","affiliate","organizational","farm system","spring training","debut","call up"];
const NEWS_SENTIMENT = { positive: 1.2, negative: -1.0, neutral: 0.3 };
const NEWS_BASE = 8;
const DECAY_LAMBDA = 0.1;
const GNEWS_DELAY_MS = 600;

function isBaseballRelevant(text) {
    if (!text) return false;
    const t = text.toLowerCase();
    return BASEBALL_KEYWORDS.some(kw => t.includes(kw));
}

function isIrrelevantContent(text) {
    if (!text) return false;
    const t = text.toLowerCase();
    return /dating|girlfriend|boyfriend|relationship status|married|wedding/i.test(t);
}

function analyzeSentiment(text) {
    if (!text) return "neutral";
    const t = text.toLowerCase();
    const pos = POSITIVE_KEYWORDS.filter(kw => t.includes(kw)).length;
    const neg = NEGATIVE_KEYWORDS.filter(kw => t.includes(kw)).length;
    return neg > pos ? "negative" : pos > neg ? "positive" : "neutral";
}

function newsContribution(articles) {
    const now = Date.now() / 1000;
    const cutoff30 = now - 30 * 86400;
    let total = 0;
    articles.forEach(a => {
        const ts = a.published_ts || 0;
        if (ts < cutoff30) return;
        const daysOld = (now - ts) / 86400;
        const decay = Math.exp(-DECAY_LAMBDA * daysOld);
        const mod = NEWS_SENTIMENT[a.sentiment] || NEWS_SENTIMENT.neutral;
        total += NEWS_BASE * decay * mod;
    });
    return total;
}

function normalizeScores(rawScores) {
    if (!rawScores.length) return [];
    const sorted = [...rawScores].sort((a,b)=>a-b);
    const p5 = sorted[Math.max(0, Math.floor(sorted.length * 0.05))];
    const p95 = sorted[Math.min(sorted.length - 1, Math.ceil(sorted.length * 0.95))];
    const range = p95 - p5 || 1;
    return rawScores.map(r => Math.min(100, Math.max(0, ((r - p5) / range) * 100)));
}

async function getProspectNamesFromIndex() {
    if (!indexFileHandle) return null;
    try {
        const file = await indexFileHandle.getFile();
        const text = await file.text();
        const matches = text.matchAll(/name:"([^"]+)"/g);
        return [...matches].map(m => m[1]);
    } catch (e) { return null; }
}

let scrapeNewsAborted = false;

function cancelNewsScrape() {
    scrapeNewsAborted = true;
}

async function scrapeNewsForAllProspects() {
    scrapeNewsAborted = false;
    const keyInput = document.getElementById('gnewsApiKey');
    const resultEl = document.getElementById('newsResult');
    const tableEl = document.getElementById('newsResultsTable');
    const btn = document.getElementById('scrapeNewsBtn');
    const cancelBtn = document.getElementById('scrapeNewsCancelBtn');
    const limitInput = document.getElementById('newsLimitInput');
    const apiKey = (keyInput?.value || '').trim();
    if (apiKey) sessionStorage.setItem('rankle-gnews-key', apiKey);
    if (!apiKey) {
        resultEl.innerHTML = '<span style="color:var(--red);">Enter your GNews API key.</span>';
        return;
    }

    let names = [];
    const fromIndex = await getProspectNamesFromIndex();
    if (fromIndex && fromIndex.length > 0) {
        names = fromIndex;
    } else if (prospects.length > 0) {
        names = prospects.map(p => p.name);
    } else {
        resultEl.innerHTML = '<span style="color:var(--red);">No prospects. Link index.html and save, or import a list first.</span>';
        return;
    }

    const limitNum = parseInt(limitInput?.value || '0', 10);
    if (limitNum > 0) names = names.slice(0, limitNum);
    resultEl.innerHTML = `<span style="color:var(--text-mid);">Scraping ${names.length} prospects‚Ä¶</span>`;

    btn.disabled = true;
    cancelBtn.style.display = 'inline-flex';
    const proxy = (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
    const results = [];
    const rawScores = [];

    for (let i = 0; i < names.length; i++) {
        if (scrapeNewsAborted) break;
        resultEl.innerHTML = `<span style="color:var(--text-mid);">Scraping ${i + 1}/${names.length}: ${names[i]}‚Ä¶</span>`;
        const fullName = names[i];
        const lastName = fullName.split(/\s+/).pop() || fullName;
        const primaryQuery = `"${fullName}" prospect baseball`;
        const fallbackQuery = `${lastName} prospect MLB`;
        const seenUrls = new Set();
        const articles = [];

        const runQuery = async (q) => {
            const url = `https://gnews.io/api/v4/search?q=${encodeURIComponent(q)}&token=${apiKey}&lang=en&max=10`;
            let data = { articles: [] };
            try {
                const r = await fetch(proxy(url));
                data = await r.json();
            } catch (e) {}
            const fullNameLc = fullName.toLowerCase();
            const lastNameLc = lastName.toLowerCase();
            (data.articles || []).forEach(item => {
                const title = (item.title || '').trim();
                if (!title) return;
                if (seenUrls.has(item.url)) return;
                seenUrls.add(item.url);
                const desc = (item.description || item.content || '').slice(0, 300);
                const content = (desc + ' ' + title).toLowerCase();
                const textForRelevance = title + ' ' + desc;
                if (!content.includes(fullNameLc) && !content.includes(lastNameLc)) return;
                if (!isBaseballRelevant(textForRelevance)) return;
                if (isIrrelevantContent(title)) return;
                const rawAt = item.publishedAt || '';
                let published_ts = 0;
                let published_at = '';
                if (rawAt.length >= 10) {
                    try {
                        const dt = new Date(rawAt.replace('Z',''));
                        published_ts = Math.floor(dt.getTime() / 1000);
                        published_at = dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    } catch (_) { published_at = rawAt.slice(0, 10); }
                }
                const sentiment = analyzeSentiment(title + ' ' + desc);
                articles.push({ title, url: item.url || '', source: (item.source || {}).name || 'Unknown', published_at, published_ts, sentiment });
            });
        };

        await runQuery(primaryQuery);
        await new Promise(r => setTimeout(r, GNEWS_DELAY_MS));
        if (articles.length < 3 && !scrapeNewsAborted) {
            await runQuery(fallbackQuery);
            await new Promise(r => setTimeout(r, GNEWS_DELAY_MS));
        }

        const raw = newsContribution(articles);
        rawScores.push(raw);
        results.push({ name: names[i], articles, raw });
    }

    const normed = normalizeScores(rawScores);
    results.forEach((r, i) => { r.score = Math.round(normed[i] * 10) / 10; });

    results.sort((a, b) => b.score - a.score);

    let html = '<table style="width:100%; border-collapse:collapse; font-size:.8rem;"><thead><tr><th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--border);">Prospect</th><th style="text-align:center; padding:.5rem; border-bottom:1px solid var(--border);">Score</th><th style="text-align:center; padding:.5rem; border-bottom:1px solid var(--border);">Articles</th><th style="text-align:left; padding:.5rem; border-bottom:1px solid var(--border);">Top headlines</th></tr></thead><tbody>';
    results.forEach(r => {
        const top2 = r.articles.slice(0, 2).map(a => `<span style="color:var(--text-mid); font-size:.75rem;">${a.title.slice(0, 60)}‚Ä¶</span> (${a.sentiment})`).join('<br>') || '‚Äî';
        html += `<tr style="border-bottom:1px solid var(--border);"><td style="padding:.5rem;">${r.name}</td><td style="padding:.5rem; text-align:center; font-weight:600; color:var(--accent-hi);">${r.score}</td><td style="padding:.5rem; text-align:center;">${r.articles.length}</td><td style="padding:.5rem;">${top2}</td></tr>`;
    });
    html += '</tbody></table>';

    tableEl.innerHTML = html;
    resultEl.innerHTML = scrapeNewsAborted
        ? `<span style="color:var(--gold);">Cancelled. Scraped ${results.length} prospects.</span>`
        : `<span style="color:var(--green);">‚úì Done. Scraped news for ${results.length} prospects.</span>`;
    btn.disabled = false;
    cancelBtn.style.display = 'none';
}

// ============================================================
// BULK UPDATE AGES & ETA ‚Äî paste "Name	Age" or "Name	Age	ETA" per line
// ============================================================
function bulkUpdateAges() {
    const text = (document.getElementById('agePasteInput')?.value || '').trim();
    const lines = text.split(/[\n\r]+/).map(l => l.trim()).filter(l => l.length > 0);
    let agesUpdated = 0, etasUpdated = 0;
    lines.forEach(line => {
        const parts = line.split(/\t|,\s*/).map(p => p.trim());
        if (parts.length < 2) return;
        const name = parts[0];
        const age = parseInt(parts[1], 10);
        const eta = parts.length >= 3 ? parts[2].replace(/[^0-9]/g, '').slice(0, 4) : null;
        const idx = fuzzyMatch(name, prospects);
        if (idx === null) return;
        if (!isNaN(age) && age >= 16 && age <= 50) { prospects[idx].age = age; agesUpdated++; }
        if (eta && eta.length === 4 && parseInt(eta) >= 2024 && parseInt(eta) <= 2030) {
            const current = prospects[idx].eta || '';
            const currentYear = parseInt(String(current).replace(/\D/g, '').slice(0, 4), 10);
            const newYear = parseInt(eta, 10);
            if (isNaN(currentYear) || newYear <= currentYear) {
                prospects[idx].eta = eta;
                etasUpdated++;
            }
        }
    });
    saveToStorage();
    renderProspects();
    renderExport();
    if (indexFileHandle) writeToIndex().then(ok => { if (ok) saveToStorage(); });
    const msg = [agesUpdated && `‚úì ${agesUpdated} ages`, etasUpdated && `‚úì ${etasUpdated} ETAs`].filter(Boolean).join(' ¬∑ ') || 'No updates';
    document.getElementById('ageResult').innerHTML = `<span style="color:var(--green);">${msg}</span>`;
}

// ============================================================
// IMPORT ‚Äî run parser, match/add, update state
// ============================================================
function importPasted() {
    const source  = document.getElementById('pasteSourceSelect').value;
    const listLen = parseInt(document.getElementById('pasteListLength').value) || 100;
    SOURCES[source].listLength = listLen;

    const parsed = runParser();
    if (!parsed.length) {
        document.getElementById('pasteResult').innerHTML = '<span style="color:var(--red);">Nothing parsed ‚Äî check the format selector.</span>';
        return;
    }

    let matched = 0, added = 0, updated = 0;

    parsed.forEach(p => {
        const idx = fuzzyMatch(p.name, prospects);
        if (idx !== null) {
            prospects[idx].ranks[source] = p.rank;
            matched++;
            if (p.team)  prospects[idx].team = p.team;
            if (p.pos)   prospects[idx].pos  = p.pos;
            if (p.age != null && !isNaN(p.age) && p.age >= 16 && p.age <= 50) prospects[idx].age = p.age;
            if (p.eta) {
                const newYear = parseInt(String(p.eta).replace(/\D/g, '').slice(0, 4), 10);
                const curYear = parseInt(String(prospects[idx].eta || '').replace(/\D/g, '').slice(0, 4), 10);
                if (!isNaN(newYear) && newYear >= 2024 && newYear <= 2030 && (isNaN(curYear) || newYear <= curYear)) {
                    prospects[idx].eta = String(newYear);
                }
            }
        } else {
            const ageVal = (p.age != null && !isNaN(p.age) && p.age >= 16 && p.age <= 50) ? p.age : 19;
            const etaVal = (p.eta && /20\d{2}/.test(String(p.eta))) ? String(p.eta).replace(/\D/g, '').slice(0, 4) : "2027";
            const blank = { name: p.name, pos: p.pos || "SS", team: p.team || "ATH", age: ageVal, eta: etaVal, ranks: {} };
            Object.keys(SOURCES).forEach(s => blank.ranks[s] = null);
            blank.ranks[source] = p.rank;
            prospects.push(blank);
            added++;
        }
    });

    lastUpdated[source] = new Date().toISOString();
    document.getElementById('previewWrap').style.display = 'none';
    renderProspects();
    renderExport();
    if (document.getElementById('panel-status').classList.contains('active')) renderStatus();

    // Auto-save to index.html if linked
    if (indexFileHandle) {
        writeToIndex().then(ok => {
            saveToStorage();
            if (ok) showToast('Saved ' + prospects.length + ' prospects to index.html', 'üíæ');
            document.getElementById('pasteResult').innerHTML =
                `<span style="color:var(--green);">‚úì ${matched} matched</span>` +
                (added ? ` ¬∑ <span style="color:var(--gold);">${added} new added</span>` : '') +
                ` ¬∑ <span style="color:var(--text-lo);">${parsed.length} total</span>` +
                (ok ? ` ¬∑ <span style="color:var(--green); font-weight:600;">üíæ saved to index.html</span>`
                     : ` ¬∑ <span style="color:var(--red);">save failed</span>`);
        });
    } else {
        document.getElementById('pasteResult').innerHTML =
            `<span style="color:var(--green);">‚úì ${matched} matched</span>` +
            (added ? ` ¬∑ <span style="color:var(--gold);">${added} new added</span>` : '') +
            ` ¬∑ <span style="color:var(--text-lo);">${parsed.length} total</span>` +
            ` <span style="color:var(--accent-hi); font-weight:600; margin-left:.6rem;">‚Üí Hit üîó Link index.html in the header to auto-save</span>`;
    }
}

// ============================================================
// EXPORT TAB ‚Äî generate the code block
// ============================================================
// Shared: generates the SOURCES + RAW_DATA code string
function generateExportCode() {
    const lines = [];

    lines.push('const SOURCES = {');
    Object.entries(SOURCES).forEach(([k,v], i) => {
        const comma = i < Object.keys(SOURCES).length - 1 ? ',' : '';
        const pad   = ' '.repeat(Math.max(1, 14 - k.length));
        lines.push(`    ${k}:${pad}{ label: "${v.label}",${' '.repeat(Math.max(1,18-v.label.length))}listLength: ${v.listLength} }${comma}`);
    });
    lines.push('};');
    lines.push('');

    lines.push('const RAW_DATA = [');
    prospects.forEach((p, i) => {
        const comma = i < prospects.length - 1 ? ',' : '';
        const rankParts = Object.keys(SOURCES).map(s => {
            const v = p.ranks[s];
            return `${s}:${v !== null ? v : 'null'}`;
        });
        const namePad = ' '.repeat(Math.max(1, 22 - p.name.length));
        const mlbPart = p.mlbId ? ` mlbId:${p.mlbId},` : '';
        lines.push(`    { name:"${p.name}",${namePad}pos:"${p.pos}", team:"${p.team}", age:${p.age}, eta:"${p.eta}",${mlbPart} ranks:{ ${rankParts.join(', ')} } }${comma}`);
    });
    lines.push('];');
    lines.push('');

    // Persist lastUpdated timestamps so the admin status tab
    // stays accurate across browsers/devices and after clearing storage.
    lines.push('const LAST_UPDATED = {');
    const entries = Object.entries(lastUpdated || {});
    entries.forEach(([k, v], i) => {
        if (!v) return;
        const comma = i < entries.length - 1 ? ',' : '';
        lines.push(`    ${k}: "${v}"${comma}`);
    });
    lines.push('};');

    return lines.join('\n');
}

// Renders the export box on the Export tab
function renderExport() {
    document.getElementById('exportBox').textContent = generateExportCode();
}

function copyExport() {
    const text = document.getElementById('exportBox').textContent;
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector('.copy-btn');
        // We use the button inside export ‚Äî trigger from the success btn instead
    });
    // Use the success button's click
    const el = document.getElementById('exportBox');
    const range = document.createRange();
    range.selectNode(el);
    window.getSelection().removeAllRanges();
    window.getSelection().addRange(range);
    document.execCommand('copy');
    window.getSelection().removeAllRanges();

    // Visual feedback on the success button
    const btn = document.querySelector('.btn-success');
    const orig = btn.innerHTML;
    btn.innerHTML = '‚úì Copied!';
    btn.style.background = 'linear-gradient(135deg,#047857,#065f46)';
    setTimeout(() => { btn.innerHTML = orig; btn.style.background = ''; }, 1500);
}

function downloadExport() {
    const text = document.getElementById('exportBox').textContent;
    const blob = new Blob([text], { type:'text/javascript' });
    const a    = document.createElement('a');
    a.href     = URL.createObjectURL(blob);
    a.download = 'rankle-data.js';
    a.click();
}

// ============================================================
// SAVE DIRECTLY TO index.html (File System Access API)
// Opens a file picker, reads the file, surgically replaces
// the SOURCES + RAW_DATA block, writes it back. Zero copy/paste.
// ============================================================
async function saveToIndexHTML() {
    const statusEl = document.getElementById('saveResult');
    if (!window.showOpenFilePicker) {
        statusEl.innerHTML = '<span style="color:var(--red);">Your browser doesn\'t support direct file saving. Use Copy to Clipboard instead.</span>';
        return;
    }
    if (indexFileHandle) {
        const ok = await writeToIndex();
        if (ok) { saveToStorage(); statusEl.innerHTML = '<span style="color:var(--green);">‚úì Saved! index.html updated with ' + prospects.length + ' prospects.</span>'; }
        else { statusEl.innerHTML = '<span style="color:var(--red);">Save failed. Try linking again (header).</span>'; }
        setTimeout(() => { statusEl.innerHTML = ''; }, 4000);
        return;
    }
    try {
        const [fileHandle] = await window.showOpenFilePicker({
            types: [{ description: 'HTML Files', accept: { 'text/html': ['.html'] } }],
            suggestedName: 'index.html'
        });

        // 2. Read current contents
        const file    = await fileHandle.getFile();
        const content = await file.text();

        // 3. Verify this is actually our index.html (has the markers)
        if (!content.includes('const SOURCES =') || !content.includes('const RAW_DATA =')) {
            statusEl.innerHTML = '<span style="color:var(--red);">That doesn\'t look like a Rankle index.html ‚Äî no SOURCES or RAW_DATA found.</span>';
            return;
        }

        // 4. Surgical replace: everything from "const SOURCES =" up to and including
        // the RAW_DATA block and optional LAST_UPDATED block
        const newData  = document.getElementById('exportBox').textContent;
        const startMarker = 'const SOURCES =';
        const endMarker   = /const RAW_DATA = \[[\s\S]*?\];(?:\s*const LAST_UPDATED = \{[\s\S]*?\};)?/;

        const startIdx = content.indexOf(startMarker);
        const afterStart = content.slice(startIdx);
        const endMatch  = afterStart.match(endMarker);

        if (startIdx === -1 || !endMatch) {
            statusEl.innerHTML = '<span style="color:var(--red);">Couldn\'t find the data block to replace. File may have been edited.</span>';
            return;
        }

        const endIdx     = startIdx + endMatch.index + endMatch[0].length;
        const newContent = content.slice(0, startIdx) + newData + content.slice(endIdx);

        // 5. Write back
        const writable = await fileHandle.createWritable();
        await writable.write(newContent);
        await writable.close();

        statusEl.innerHTML = '<span style="color:var(--green);">‚úì Saved! Link index.html in the header for one-click save next time.</span>';
        setTimeout(() => { statusEl.innerHTML = ''; }, 4000);
    } catch (err) {
        if (err.name === 'AbortError') return;
        statusEl.innerHTML = '<span style="color:var(--red);">Error: ' + err.message + '</span>';
    }
}


// ============================================================
// TOAST NOTIFICATION
// ============================================================
let toastTimer = null;
function showToast(msg, icon) {
    const toast  = document.getElementById('toast');
    const msgEl  = document.getElementById('toastMsg');
    const iconEl = toast.querySelector('.toast-icon');
    if (icon) iconEl.textContent = icon;
    msgEl.textContent = msg;
    toast.classList.add('show');
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(() => toast.classList.remove('show'), 3000);
}

// ============================================================
// PERSISTENCE ‚Äî localStorage save/load
// ============================================================
const STORAGE_KEY = 'rankle-admin-data';

// lastUpdated: { pipeline: "2026-02-03T14:30:00Z", ... }
let lastUpdated = {};
let lastPasteSource = null;

// Merge LAST_UPDATED data from an index.html string (if present) into lastUpdated
function updateLastUpdatedFromIndexContent(text) {
    try {
        const m = text.match(/const LAST_UPDATED = \{([\s\S]*?)\};/);
        if (!m) return;
        const body = m[1];
        const lines = body.split('\n');
        const parsed = {};
        lines.forEach(line => {
            const trimmed = line.trim();
            if (!trimmed) return;
            const m2 = trimmed.match(/^(\w+)\s*:\s*"([^"]*)"\s*,?$/);
            if (m2) {
                parsed[m2[1]] = m2[2];
            }
        });
        Object.keys(parsed).forEach(key => {
            if (parsed[key]) {
                lastUpdated[key] = parsed[key];
            }
        });
    } catch(e) {
        // If parsing fails, ignore and fall back to localStorage-only timestamps
    }
}

function saveToStorage() {
    try {
        const sel = document.getElementById('pasteSourceSelect');
        const src = sel ? sel.value : lastPasteSource;
        localStorage.setItem(STORAGE_KEY, JSON.stringify({ SOURCES, prospects, lastUpdated, lastPasteSource: src }));
    } catch(e) { /* silent */ }
}

function loadFromStorage() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const data = JSON.parse(raw);
        if (data.lastUpdated) lastUpdated = data.lastUpdated;
        if (data.lastPasteSource) lastPasteSource = data.lastPasteSource;
        if (data.prospects && Array.isArray(data.prospects) && data.prospects.length > 0) {
            prospects = data.prospects;
            prospects.forEach(p => {
                Object.keys(SOURCES).forEach(s => {
                    if (!(s in p.ranks)) p.ranks[s] = null;
                });
            });
            if (data.SOURCES) {
                Object.keys(data.SOURCES).forEach(k => {
                    if (SOURCES[k] && data.SOURCES[k].listLength) {
                        SOURCES[k].listLength = data.SOURCES[k].listLength;
                    }
                });
            }
            return true;
        }
    } catch(e) { /* silent */ }
    return false;
}

// ============================================================
// RENDER STATUS TAB ‚Äî last updated timestamps per source
// ============================================================
function renderStatus() {
    const el = document.getElementById('statusList');
    const now = new Date();
    const formatTs = (ts) => {
        if (!ts) return { text: 'Never', stale: true };
        const d = new Date(ts);
        const days = (now - d) / (24*60*60*1000);
        let text = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        if (days >= 14) text += ' (2+ weeks ago)';
        else if (days >= 7) text += ' (1+ week ago)';
        return { text, stale: days > 7 };
    };
    el.innerHTML = Object.entries(SOURCES).map(([key, src]) => {
        const { text, stale } = formatTs(lastUpdated[key]);
        const row = document.createElement('div');
        row.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:.6rem .8rem; background:var(--bg-input); border:1px solid var(--border); border-radius:8px;';
        row.innerHTML = `
            <span style="font-weight:600;">${src.label}</span>
            <span style="font-size:.85rem; color:${stale ? 'var(--gold)' : 'var(--text-mid)'};">${text}</span>
        `;
        return row.outerHTML;
    }).join('');
}

// ============================================================
// INIT
// ============================================================
const loaded = loadFromStorage();
renderProspects();
renderExport();

// Restore linked file handle from IndexedDB (skip re-linking)
restoreFileHandle().then(() => {
    const btn = document.getElementById('importBtn');
    if (btn) btn.textContent = indexFileHandle ? 'Import & Save' : 'Import Rankings';
});

// Restore last paste source
if (lastPasteSource && document.getElementById('pasteSourceSelect')) {
    document.getElementById('pasteSourceSelect').value = lastPasteSource;
    document.getElementById('pasteListLength').value = SOURCES[lastPasteSource]?.listLength || 100;
}

if (loaded) showToast('Loaded ' + prospects.length + ' prospects from last session', 'üìÇ');
</script>

<!-- TOAST -->
<div class="toast" id="toast">
    <span class="toast-icon">üíæ</span>
    <span id="toastMsg">Saved!</span>
</div>
</body>
</html>